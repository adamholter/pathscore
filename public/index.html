<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PathScore — SVG Generation Benchmark</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='4' fill='%230a0a0a'/><circle cx='16' cy='16' r='6' fill='none' stroke='%23e84d2f' stroke-width='2.5'/><line x1='16' y1='4' x2='16' y2='10' stroke='%23e84d2f' stroke-width='2.5'/><line x1='16' y1='22' x2='16' y2='28' stroke='%23e84d2f' stroke-width='2.5'/><line x1='4' y1='16' x2='10' y2='16' stroke='%23e84d2f' stroke-width='2.5'/><line x1='22' y1='16' x2='28' y2='16' stroke='%23e84d2f' stroke-width='2.5'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--ink:#0a0a0a;--ember:#e84d2f;--white:#ffffff;--mist:#f5f5f5;--stone:#999999;--border:#e8e8e8;--font-h:'Outfit',sans-serif;--font-b:'IBM Plex Mono',monospace;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--font-b);background:var(--white);color:var(--ink);font-size:14px;line-height:1.6;}
a{color:inherit;text-decoration:none;}
.app{min-height:100vh;display:flex;flex-direction:column;}
.nav{border-bottom:1.5px solid var(--border);padding:0 32px;display:flex;align-items:center;gap:32px;height:56px;background:var(--white);position:sticky;top:0;z-index:100;}
.nav-logo{display:flex;align-items:center;gap:10px;cursor:pointer;}
.nav-logo-text{font-family:var(--font-h);font-weight:800;font-size:18px;letter-spacing:-0.02em;}
.nav-dot{width:8px;height:8px;background:var(--ember);border-radius:50%;}
.nav-links{display:flex;gap:24px;margin-left:auto;}
.nav-link{font-size:12px;font-weight:500;letter-spacing:0.04em;color:var(--stone);cursor:pointer;transition:color .15s;}
.nav-link:hover,.nav-link.active{color:var(--ink);}
.main{flex:1;}
.page{display:none;padding:48px 32px;max-width:1200px;margin:0 auto;}
.page.active{display:block;}
h1{font-family:var(--font-h);font-weight:800;font-size:32px;letter-spacing:-0.03em;line-height:1.1;}
h2{font-family:var(--font-h);font-weight:700;font-size:22px;letter-spacing:-0.02em;}
h3{font-family:var(--font-h);font-weight:600;font-size:16px;}
.stone{color:var(--stone);}
.ember{color:var(--ember);}
.btn{font-family:var(--font-b);font-weight:500;font-size:13px;letter-spacing:0.04em;padding:10px 20px;border-radius:4px;border:none;cursor:pointer;transition:opacity .15s;display:inline-flex;align-items:center;gap:8px;}
.btn:hover{opacity:.85;}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-primary{background:var(--ink);color:white;}
.btn-accent{background:var(--ember);color:white;}
.btn-outline{background:transparent;color:var(--ink);border:1.5px solid var(--ink);padding:9px 19px;}
.btn-ghost{background:transparent;color:var(--stone);padding:8px 12px;}
.btn-sm{font-size:11px;padding:7px 14px;}
.card{border:1.5px solid var(--border);border-radius:6px;padding:20px;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.field{margin-bottom:20px;}
.label{display:block;font-size:11px;font-weight:500;letter-spacing:.08em;text-transform:uppercase;color:var(--stone);margin-bottom:8px;}
input[type=text],input[type=number],select,textarea{width:100%;font-family:var(--font-b);font-size:13px;padding:10px 12px;border:1.5px solid var(--border);border-radius:4px;background:var(--white);color:var(--ink);outline:none;transition:border-color .15s;}
input:focus,select:focus,textarea:focus{border-color:var(--ink);}
.divider{border:none;border-top:1.5px solid var(--border);margin:28px 0;}
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:6px;}
.s-draft .status-dot{background:var(--stone);}
.s-running .status-dot{background:#2196F3;animation:pulse 1s infinite;}
.s-complete .status-dot{background:#4CAF50;}
.s-error .status-dot{background:var(--ember);}
.s-stopped .status-dot{background:var(--stone);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.pbar{height:3px;background:var(--mist);border-radius:2px;overflow:hidden;}
.pbar-fill{height:100%;background:var(--ember);transition:width .3s;border-radius:2px;}
.hero{padding:64px 0 48px;border-bottom:1.5px solid var(--border);margin-bottom:48px;}
.hero-eyebrow{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--stone);margin-bottom:16px;}
.hero h1{margin-bottom:16px;}
.hero-sub{font-size:15px;color:var(--stone);max-width:560px;line-height:1.7;margin-bottom:32px;}
.run-list{display:flex;flex-direction:column;gap:12px;}
.run-card{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:24px;padding:20px 24px;border:1.5px solid var(--border);border-radius:6px;cursor:pointer;transition:border-color .15s;}
.run-card:hover{border-color:var(--ink);}
.run-card-name{font-family:var(--font-h);font-weight:600;font-size:15px;margin-bottom:4px;}
.run-card-meta{font-size:11px;color:var(--stone);display:flex;gap:16px;}
.run-progress-col{min-width:140px;}
.run-progress-label{display:flex;justify-content:space-between;font-size:11px;color:var(--stone);margin-bottom:6px;}
.empty-state{padding:64px;text-align:center;color:var(--stone);border:1.5px dashed var(--border);border-radius:6px;}
.empty-state h3{font-family:var(--font-h);margin-bottom:8px;color:var(--ink);}
.config-layout{display:grid;grid-template-columns:200px 1fr;gap:48px;}
.config-sidebar{position:sticky;top:72px;height:fit-content;}
.config-steps{display:flex;flex-direction:column;gap:4px;}
.config-step{display:flex;align-items:center;gap:12px;padding:10px 16px;border-radius:4px;cursor:pointer;font-size:13px;color:var(--stone);transition:all .15s;}
.config-step:hover{background:var(--mist);color:var(--ink);}
.config-step.active{background:var(--ink);color:white;}
.config-step-num{width:22px;height:22px;border-radius:50%;border:1.5px solid currentColor;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;}
.config-panel{display:none;}
.config-panel.active{display:block;}
.model-search-wrap{position:relative;margin-bottom:8px;}
.model-search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--stone);pointer-events:none;}
.model-search-input{padding-left:36px !important;}
.model-dropdown{border:1.5px solid var(--border);border-radius:4px;max-height:280px;overflow-y:auto;background:white;}
.model-option{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;transition:background .1s;}
.model-option:last-child{border-bottom:none;}
.model-option:hover,.model-option.selected{background:var(--mist);}
.model-option-id{font-size:12px;}
.model-option-meta{font-size:11px;color:var(--stone);white-space:nowrap;}
.load-more{text-align:center;padding:10px;cursor:pointer;font-size:12px;color:var(--stone);border-top:1px solid var(--border);}
.load-more:hover{color:var(--ink);}
.sel-models{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.sel-model-row{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--mist);border-radius:4px;min-width:0;}
.sel-model-id{font-size:11px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--font-b);}
.reasoning-sel{font-size:11px;padding:3px 6px;border:1px solid var(--border);border-radius:3px;background:white;font-family:var(--font-b);flex-shrink:0;width:90px;}
.rm-btn{flex-shrink:0;background:none;border:none;cursor:pointer;color:var(--stone);font-size:16px;padding:0 2px;line-height:1;}
.rm-btn:hover{color:var(--ember);}
.prompt-list{display:flex;flex-direction:column;gap:8px;}
.prompt-row{display:flex;align-items:center;gap:8px;}
.prompt-text-input{flex:1;}
.prompt-cat{width:140px;}
.adv-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--stone);padding:8px 0;border:none;background:none;font-family:var(--font-b);}
.adv-toggle:hover{color:var(--ink);}
.adv-toggle svg{transition:transform .2s;}
.adv-toggle.open svg{transform:rotate(90deg);}
.adv-section{display:none;padding-top:16px;border-top:1px solid var(--border);margin-top:12px;}
.adv-section.open{display:block;}
.rr{display:flex;align-items:center;gap:12px;}
.rr input[type=range]{flex:1;}
.rv{font-size:13px;color:var(--stone);min-width:50px;text-align:right;}
.ai-gen-box{background:var(--mist);border-radius:6px;padding:16px;margin-top:16px;}
.ai-gen-row{display:flex;gap:8px;}
.run-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px;}
.stat-box{border:1.5px solid var(--border);border-radius:6px;padding:16px 20px;}
.stat-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);margin-bottom:8px;}
.stat-val{font-family:var(--font-h);font-weight:800;font-size:28px;}
.stat-sub{font-size:11px;color:var(--stone);margin-top:4px;}
.run-cols{display:grid;grid-template-columns:1fr 1fr;gap:24px;}
.event-feed{max-height:480px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.event-item{padding:10px 14px;border-radius:4px;font-size:12px;border-left:3px solid transparent;}
.ev-gen-start{background:#f0f4ff;border-color:#2196F3;}
.ev-gen-ok{background:#f0fff4;border-color:#4CAF50;}
.ev-gen-err{background:#fff0f0;border-color:var(--ember);}
.ev-cmp-start{background:var(--mist);border-color:var(--stone);}
.ev-cmp-ok{background:#fff8f0;border-color:#FF9800;}
.ev-cmp-err{background:#fff0f0;border-color:var(--ember);}
.ev-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;}
.ev-title{font-weight:500;font-size:11px;letter-spacing:.04em;}
.ev-time{font-size:10px;color:var(--stone);}
.ev-meta{font-size:11px;color:var(--stone);}
.wb{font-size:11px;font-weight:600;padding:2px 8px;border-radius:3px;}
.wb-a{background:#e3f2fd;color:#1565C0;}
.wb-b{background:#fce4ec;color:#880E4F;}
.wb-tie{background:var(--mist);color:var(--stone);}
.svg-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;max-height:480px;overflow-y:auto;}
.svg-thumb{border:1.5px solid var(--border);border-radius:4px;overflow:hidden;cursor:pointer;transition:border-color .15s;}
.svg-thumb:hover{border-color:var(--ink);}
.svg-thumb-img{width:100%;aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:var(--mist);}
.svg-thumb-img img{width:100%;height:100%;object-fit:contain;}
.svg-thumb-meta{padding:6px 8px;}
.svg-thumb-model{font-size:10px;color:var(--stone);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.svg-thumb-prompt{font-size:10px;color:var(--stone);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
table.lb{width:100%;}
table.lb th{text-align:left;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);padding:10px 16px;border-bottom:1.5px solid var(--border);font-weight:500;}
table.lb td{padding:14px 16px;border-bottom:1px solid var(--border);vertical-align:middle;}
table.lb tr:hover td{background:var(--mist);}
.rank{font-family:var(--font-h);font-weight:800;font-size:18px;}
.r1{color:#B8860B;}.r2{color:var(--stone);}.r3{color:#CD7F32;}
.elo-bar-row{display:flex;align-items:center;gap:12px;}
.elo-bar{height:8px;background:var(--mist);border-radius:4px;flex:1;min-width:80px;overflow:hidden;}
.elo-bar-fill{height:100%;background:var(--ember);border-radius:4px;}
.elo-num{font-family:var(--font-h);font-weight:700;font-size:15px;min-width:50px;}
.hm-wrap{overflow-x:auto;}
.hm-table{border-collapse:collapse;}
.hm-table th{font-size:11px;color:var(--stone);padding:8px 12px;font-weight:400;white-space:nowrap;}
.hm-table td{width:80px;height:60px;text-align:center;border:2px solid white;}
.hm-cell{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:12px;font-weight:500;border-radius:3px;}
.hm-na{background:var(--mist);color:var(--stone);}
.hm-row-lbl{font-size:11px;color:var(--stone);white-space:nowrap;padding-right:12px;text-align:right;}
.tabs{display:flex;gap:0;border-bottom:1.5px solid var(--border);margin-bottom:32px;}
.tab{font-family:var(--font-b);font-size:12px;font-weight:500;letter-spacing:.04em;padding:12px 20px;cursor:pointer;border-bottom:2px solid transparent;color:var(--stone);margin-bottom:-1.5px;transition:all .15s;}
.tab:hover{color:var(--ink);}
.tab.active{color:var(--ink);border-bottom-color:var(--ember);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}
.export-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:16px 20px;background:var(--mist);border-radius:6px;margin-bottom:32px;}
.export-lbl{font-size:11px;color:var(--stone);letter-spacing:.06em;text-transform:uppercase;}
.cmp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;}
.cmp-card{border:1.5px solid var(--border);border-radius:6px;overflow:hidden;}
.cmp-card-hdr{padding:12px 16px;background:var(--mist);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;}
.cmp-prompt{font-size:11px;color:var(--stone);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cmp-images{display:grid;grid-template-columns:1fr 1fr;}
.cmp-img-slot{padding:12px;}
.cmp-svg-box{aspect-ratio:1;border:1px solid var(--border);border-radius:3px;overflow:hidden;background:var(--mist);cursor:pointer;}
.cmp-svg-box img{width:100%;height:100%;object-fit:contain;}
.cmp-card-ftr{padding:10px 14px;border-top:1px solid var(--border);font-size:11px;color:var(--stone);}
.outputs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(10,10,10,.6);z-index:1000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:white;border-radius:6px;max-width:560px;width:90%;max-height:90vh;overflow-y:auto;padding:32px;position:relative;}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;cursor:pointer;font-size:20px;color:var(--stone);}
.modal-close:hover{color:var(--ink);}
.about-hero{padding:64px 0 48px;border-bottom:1.5px solid var(--border);margin-bottom:56px;}
.about-sec{margin-bottom:64px;}
.about-sec h2{margin-bottom:8px;font-size:22px;}
.about-sec p{color:var(--stone);line-height:1.8;margin-bottom:16px;}
.about-sec code{font-family:var(--font-b);background:var(--mist);padding:2px 6px;border-radius:3px;font-size:12px;}
.about-sec-label{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--ember);margin-bottom:8px;font-weight:600;}
.formula{background:var(--mist);border-radius:6px;padding:16px 20px;font-family:var(--font-b);font-size:13px;margin:16px 0;border:1px solid var(--border);}
.pipe-step{display:flex;flex-direction:column;align-items:center;text-align:center;padding:0 12px;position:relative;z-index:1;}
.pipe-num{font-family:var(--font-b);font-size:10px;color:var(--stone);margin-bottom:8px;letter-spacing:.08em;}
.pipe-icon{width:56px;height:56px;background:white;border:2px solid var(--ink);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:12px;}
.pipe-title{font-weight:700;font-size:13px;margin-bottom:6px;}
.pipe-body{font-size:12px;color:var(--stone);line-height:1.6;}
.mode-info-card{border:1.5px solid var(--border);border-radius:6px;padding:20px;background:white;}
.mode-info-icon{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;}
.mode-info-title{font-weight:700;font-size:14px;margin-bottom:6px;}
.mode-info-body{font-size:12px;color:var(--stone);line-height:1.6;}
.bias-card{background:var(--mist);border-radius:6px;padding:20px;border-left:3px solid var(--ink);}
.bias-title{font-weight:700;font-size:13px;margin-bottom:8px;}
.bias-body{font-size:12px;color:var(--stone);line-height:1.6;}
.pair-node{width:36px;height:36px;border-radius:50%;background:var(--ink);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;font-family:var(--font-b);}
.cat-pill{display:inline-block;font-size:10px;letter-spacing:.06em;text-transform:uppercase;padding:3px 10px;border-radius:12px;background:var(--mist);color:var(--stone);margin:2px;}
.toasts{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px;}
.toast{background:var(--ink);color:white;padding:12px 20px;border-radius:4px;font-size:13px;animation:toastIn .2s;max-width:360px;}
.toast.err{background:var(--ember);}
@keyframes toastIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:var(--mist);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--stone);}
.mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px;}
.mode-card{border:1.5px solid var(--border);border-radius:6px;padding:16px;cursor:pointer;transition:all .15s;}
.mode-card:hover{border-color:var(--stone);}
.mode-card.selected{border-color:var(--ember);background:#fff8f7;}
.mode-card-icon{font-size:20px;margin-bottom:8px;}
.mode-card-title{font-family:var(--font-h);font-weight:600;font-size:14px;margin-bottom:4px;}
.mode-card-desc{font-size:11px;color:var(--stone);line-height:1.5;}
/* Judge Eval Voting UI */
.je-progress-bar{height:4px;background:var(--border);border-radius:2px;margin-bottom:20px;}
.je-progress-fill{height:100%;background:var(--ember);border-radius:2px;transition:width .3s;}
.je-prompt{font-family:var(--font-b);font-size:13px;color:var(--stone);text-align:center;margin-bottom:20px;letter-spacing:.04em;text-transform:uppercase;}
.je-svgs{display:grid;grid-template-columns:1fr 1fr;gap:24px;max-width:960px;margin:0 auto;}
.je-panel{display:flex;flex-direction:column;align-items:center;gap:12px;}
.je-panel-label{font-family:var(--font-b);font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);}
.je-svg-img{width:100%;max-width:420px;height:320px;object-fit:contain;border:1.5px solid var(--border);border-radius:6px;background:#fafafa;}
.je-vote-btn{width:100%;max-width:420px;padding:11px 16px;border:1.5px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-family:var(--font-b);font-size:13px;transition:all .15s;}
.je-vote-btn:hover,.je-vote-btn:focus{border-color:var(--ember);background:rgba(232,77,47,.06);outline:none;}
.je-vote-btn kbd{display:inline-block;padding:1px 5px;border:1px solid #ccc;border-radius:3px;font-size:10px;background:#f5f5f5;margin-left:6px;}
.je-vote-bad{padding:9px 24px;border:1.5px dashed var(--border);border-radius:6px;background:#fff;cursor:pointer;font-family:var(--font-b);font-size:12px;color:var(--stone);transition:all .15s;}
.je-vote-bad:hover{border-color:#999;color:var(--ink);}
.je-vote-bad kbd{display:inline-block;padding:1px 5px;border:1px solid #ccc;border-radius:3px;font-size:10px;background:#f5f5f5;margin-left:4px;}
.je-reveal{max-width:960px;margin:24px auto 0;border:1.5px solid var(--border);border-radius:8px;overflow:hidden;}
.je-reveal-hdr{padding:12px 20px;background:var(--mist);border-bottom:1px solid var(--border);font-family:var(--font-b);font-size:11px;letter-spacing:.08em;text-transform:uppercase;}
.je-verdict-row{display:flex;align-items:center;gap:16px;padding:10px 20px;border-bottom:1px solid var(--border);}
.je-verdict-row:last-child{border-bottom:none;}
.je-verdict-judge{flex:1;font-size:13px;font-family:var(--font-b);}
.je-verdict-pick{font-weight:700;font-size:13px;}
.je-verdict-agree{font-size:13px;font-weight:700;}
.je-verdict-agree.correct{color:#22c55e;}
.je-verdict-agree.wrong{color:#ef4444;}
.je-verdict-feedback{flex:2;font-size:11px;color:var(--stone);}
.je-next-btn{display:block;width:100%;padding:12px;background:var(--ink);color:#fff;border:none;cursor:pointer;font-family:var(--font-b);font-size:12px;letter-spacing:.06em;text-transform:uppercase;}
.je-next-btn:hover{background:var(--ember);}
.human-judge-panel{max-width:800px;}
.human-cmp-card{border:1.5px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:24px;}
.human-cmp-hdr{padding:14px 20px;background:var(--mist);border-bottom:1px solid var(--border);}
.human-cmp-images{display:grid;grid-template-columns:1fr 1fr;gap:0;}
.human-img-slot{padding:16px;border-right:1px solid var(--border);}
.human-img-slot:last-child{border-right:none;}
.human-cmp-footer{padding:16px 20px;border-top:1px solid var(--border);}
.score-row{display:flex;align-items:center;gap:12px;margin-top:8px;}
.score-row label{font-size:11px;color:var(--stone);min-width:60px;}
.score-row input[type=range]{flex:1;}
.vote-btns{display:flex;gap:8px;margin-top:16px;}
.vote-btn{flex:1;padding:12px;border:1.5px solid var(--border);border-radius:4px;cursor:pointer;font-family:var(--font-b);font-size:13px;background:white;transition:all .15s;}
.vote-btn:hover{border-color:var(--ink);}
.vote-btn.vote-a{border-color:#2196F3;color:#1565C0;}
.vote-btn.vote-b{border-color:#e91e63;color:#880E4F;}
.vote-btn.vote-bb{border-color:var(--stone);color:var(--stone);}
.img-upload-area{border:2px dashed var(--border);border-radius:6px;padding:32px;text-align:center;cursor:pointer;transition:border-color .15s;}
.img-upload-area:hover{border-color:var(--stone);}
.img-upload-area.has-image{border-color:var(--ember);padding:8px;}
.img-thumbnail{max-width:100%;max-height:200px;display:block;margin:0 auto;border-radius:3px;}
.iter-cmp-card{border:1.5px solid var(--border);border-radius:6px;overflow:hidden;}
.iter-cmp-grid{display:grid;grid-template-columns:1fr 1fr 1fr;}
.iter-cmp-slot{padding:12px;border-right:1px solid var(--border);}
.iter-cmp-slot:last-child{border-right:none;}
.both-bad-badge{display:inline-block;font-size:10px;padding:2px 8px;border-radius:10px;background:#fff0f0;color:var(--ember);border:1px solid var(--ember);}
/* Landing */
.landing-hero{display:grid;grid-template-columns:1fr 1fr;gap:64px;align-items:center;padding:64px 0 80px;border-bottom:1.5px solid var(--border);margin-bottom:72px;}
.landing-eyebrow{font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:var(--ember);font-weight:600;margin-bottom:20px;}
.landing-h1{font-size:clamp(36px,5vw,60px);line-height:1.05;font-weight:800;margin-bottom:20px;}
.landing-sub{font-size:15px;color:var(--stone);line-height:1.75;max-width:420px;}
.landing-hero-right{display:flex;flex-direction:column;align-items:center;gap:32px;}
.landing-crosshair{width:220px;height:220px;flex-shrink:0;}
.landing-stat-chips{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;}
.stat-chip{background:var(--mist);border:1.5px solid var(--border);border-radius:6px;padding:14px 16px;}
.stat-chip-n{display:block;font-family:var(--font-h);font-weight:800;font-size:26px;line-height:1;margin-bottom:4px;}
.stat-chip-l{font-size:11px;color:var(--stone);}
.landing-steps{display:grid;grid-template-columns:repeat(4,1fr);gap:24px;}
.landing-step{display:flex;flex-direction:column;gap:12px;}
.landing-step-n{font-family:var(--font-b);font-size:11px;color:var(--ember);letter-spacing:.08em;}
.landing-step-title{font-weight:700;font-size:14px;margin-bottom:4px;}
.landing-step-body{font-size:12px;color:var(--stone);line-height:1.7;}
.landing-features{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.landing-feature{border:1.5px solid var(--border);border-radius:6px;padding:24px;background:white;}
.landing-feature-icon{width:38px;height:38px;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;}
.lf-black{background:var(--ink);color:white;}
.lf-ember{background:var(--ember);color:white;}
.landing-feature-title{font-weight:700;font-size:14px;margin-bottom:6px;}
.landing-feature-body{font-size:12px;color:var(--stone);line-height:1.65;}
.landing-svg-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}
.landing-lb-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.landing-lb-rank{font-family:var(--font-b);font-size:11px;color:var(--stone);width:24px;flex-shrink:0;}
.landing-lb-model{flex:1;min-width:0;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.landing-lb-elo{font-family:var(--font-b);font-size:13px;font-weight:700;}
.landing-lb-bar{flex:0 0 120px;height:4px;background:var(--mist);border-radius:2px;overflow:hidden;}
.landing-lb-fill{height:100%;background:var(--ink);border-radius:2px;}
@media(max-width:900px){.landing-hero{grid-template-columns:1fr;gap:40px;}.landing-steps{grid-template-columns:1fr 1fr;}.landing-features{grid-template-columns:1fr 1fr;}}
@media(max-width:768px){.config-layout{grid-template-columns:1fr;}.config-sidebar{position:static;}.stats-row{grid-template-columns:1fr 1fr;}.run-cols{grid-template-columns:1fr;}.grid2{grid-template-columns:1fr;}.mode-cards{grid-template-columns:1fr;}.landing-hero{grid-template-columns:1fr;}.landing-steps{grid-template-columns:1fr 1fr;}.landing-features{grid-template-columns:1fr;}}

/* ── Extension System ─────────────────────────────────────────── */
.ext-hook-badge{display:inline-block;font-size:10px;font-weight:500;letter-spacing:.06em;text-transform:uppercase;padding:2px 8px;border-radius:10px;}
.badge-provider{background:#d4edda;color:#155724;}
.badge-judge{background:#cce5ff;color:#004085;}
.badge-mode{background:#fff3cd;color:#856404;}
.badge-results{background:#f8d7da;color:#721c24;}
.toggle-switch{position:relative;width:36px;height:20px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:background .2s;}
.toggle-slider:before{content:'';position:absolute;width:14px;height:14px;left:3px;bottom:3px;background:white;border-radius:50%;transition:transform .2s;}
.toggle-switch input:checked + .toggle-slider{background:var(--ember);}
.toggle-switch input:checked + .toggle-slider:before{transform:translateX(16px);}
.ext-card{border:1.5px solid var(--border);border-radius:6px;padding:16px 20px;display:flex;align-items:flex-start;gap:16px;transition:border-color .15s;}
.ext-card:hover{border-color:var(--stone);}
.ext-card-body{flex:1;min-width:0;}
.ext-card-name{font-family:var(--font-h);font-weight:600;font-size:14px;margin-bottom:4px;}
.ext-card-desc{font-size:12px;color:var(--stone);margin-bottom:8px;line-height:1.5;}
.ext-card-actions{display:flex;align-items:center;gap:10px;margin-top:8px;}
.ext-grid{display:flex;flex-direction:column;gap:10px;}
.ai-chat-wrap{display:flex;flex-direction:column;height:480px;border:1.5px solid var(--border);border-radius:6px;overflow:hidden;}
.ai-chat-header{padding:12px 16px;border-bottom:1.5px solid var(--border);display:flex;align-items:center;gap:12px;background:var(--mist);}
.ai-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.ai-msg{max-width:80%;padding:10px 14px;border-radius:8px;font-size:13px;line-height:1.6;white-space:pre-wrap;}
.ai-msg-user{background:var(--ink);color:white;align-self:flex-end;border-radius:8px 8px 2px 8px;}
.ai-msg-assistant{background:var(--mist);color:var(--ink);align-self:flex-start;border-radius:8px 8px 8px 2px;}
.ai-msg pre{background:#0a0a0a;color:#e8e8e8;border-radius:4px;padding:12px;font-family:var(--font-b);font-size:12px;margin:8px 0;overflow-x:auto;white-space:pre;}
.ai-msg .use-code-btn{font-size:11px;background:var(--ember);color:white;border:none;border-radius:3px;padding:4px 10px;cursor:pointer;margin-top:4px;}
.ai-chat-footer{padding:12px;border-top:1.5px solid var(--border);display:flex;gap:8px;}
.ai-chat-footer textarea{flex:1;font-family:var(--font-b);font-size:13px;padding:8px 12px;border:1.5px solid var(--border);border-radius:4px;resize:none;height:40px;outline:none;}
.ai-chat-footer textarea:focus{border-color:var(--ink);}
.ext-code-editor{width:100%;font-family:var(--font-b);font-size:12px;padding:12px;border:1.5px solid var(--border);border-radius:4px;background:#0a0a0a;color:#e8e8e8;height:380px;resize:vertical;outline:none;line-height:1.6;}
.ext-code-editor:focus{border-color:var(--stone);}
.syntax-result{font-size:12px;padding:6px 10px;border-radius:3px;margin-top:6px;display:none;}
.syntax-ok{background:#d4edda;color:#155724;display:block;}
.syntax-err{background:#f8d7da;color:#721c24;display:block;}

    /* ===== FLOW BUILDER ===== */
    .page-flow-fullbleed { display:flex; flex-direction:column; height:calc(100vh - 52px); padding:0; max-width:none; }
    .flow-topbar { display:flex; align-items:center; justify-content:space-between; padding:8px 14px; border-bottom:1px solid var(--border); background:#fff; gap:10px; flex-shrink:0; flex-wrap:wrap; }
    .flow-topbar-left { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .flow-topbar-right { display:flex; align-items:center; gap:8px; }
    .flow-back-btn { background:none; border:1px solid var(--border); border-radius:6px; padding:5px 10px; font-family:var(--font-b); font-size:12px; cursor:pointer; color:var(--stone); }
    .flow-back-btn:hover { border-color:var(--ink); color:var(--ink); }
    .flow-title-label { font-family:var(--font-b); font-size:13px; font-weight:700; color:var(--ink); padding:0 10px; border-left:1px solid var(--border); letter-spacing:1px; }
    .flow-preset-label { font-size:10px; color:var(--stone); letter-spacing:2px; text-transform:uppercase; }
    .flow-preset-btn { background:none; border:1px solid var(--border); border-radius:6px; padding:4px 10px; font-family:var(--font-b); font-size:11px; cursor:pointer; color:var(--ink); white-space:nowrap; }
    .flow-preset-btn:hover { border-color:var(--ember); color:var(--ember); }
    .flow-preset-btn.active { border-color:var(--ember); background:var(--ember); color:#fff; }
    .flow-add-menu { position:relative; }
    .flow-add-btn { background:none; border:1px solid var(--border); border-radius:6px; padding:5px 10px; font-family:var(--font-b); font-size:12px; cursor:pointer; color:var(--ink); }
    .flow-add-btn:hover { border-color:var(--ember); color:var(--ember); }
    .flow-add-dd { position:absolute; top:110%; right:0; background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.12); min-width:160px; z-index:1000; display:none; overflow:hidden; }
    .flow-add-dd.open { display:block; }
    .flow-add-dd button { display:block; width:100%; text-align:left; background:none; border:none; border-bottom:1px solid var(--border); padding:9px 14px; font-family:var(--font-b); font-size:12px; cursor:pointer; color:var(--ink); }
    .flow-add-dd button:last-child { border-bottom:none; }
    .flow-add-dd button:hover { background:var(--mist); }
    .flow-clear-btn { background:none; border:1px solid var(--border); border-radius:6px; padding:5px 12px; font-family:var(--font-b); font-size:12px; cursor:pointer; color:var(--stone); }
    .flow-clear-btn:hover { border-color:var(--ember); color:var(--ember); }
    .flow-launch-btn { background:var(--ember); color:#fff; border:none; border-radius:6px; padding:6px 16px; font-family:var(--font-b); font-size:13px; font-weight:700; cursor:pointer; letter-spacing:0.5px; }
    .flow-launch-btn:hover { background:#c73d22; }
    .flow-body { display:flex; flex:1; overflow:hidden; }
    #drawflow { flex:1; position:relative; overflow:hidden; }
    /* Drawflow canvas dot grid */
    #drawflow > .parent-drawflow { background:var(--mist) !important; background-image:radial-gradient(circle, #c8c8c8 1px, transparent 1px) !important; background-size:24px 24px !important; }
    /* Drawflow node overrides */
    .drawflow .drawflow-node { background:#fff; border:1.5px solid var(--border); border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.07); padding:0; font-family:var(--font-b); min-width:220px; }
    .drawflow .drawflow-node.selected { border-color:var(--ember); box-shadow:0 0 0 3px rgba(232,77,47,0.15); }
    .drawflow .drawflow-node .drawflow_content_node { padding:0; }
    .drawflow .drawflow-node .input, .drawflow .drawflow-node .output { background:#fff; border:2px solid #ccc; width:13px; height:13px; border-radius:50%; top:50%; }
    .drawflow .drawflow-node .input:hover, .drawflow .drawflow-node .output:hover { background:var(--ember); border-color:var(--ember); }
    .drawflow .connection .main-path { stroke:var(--ink); stroke-width:2px; fill:none; }
    /* PathScore node parts */
    .ps-node-header { background:var(--ink); color:#fff; font-family:var(--font-b); font-size:10px; letter-spacing:2.5px; text-transform:uppercase; padding:8px 12px 8px 10px; border-radius:6px 6px 0 0; display:flex; align-items:center; gap:7px; }
    .ps-node-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .dot-model { background:#4ade80; }
    .dot-prompt { background:#60a5fa; }
    .dot-judge { background:#f59e0b; }
    .dot-runner { background:var(--ember); }
    .dot-results { background:#a855f7; }
    .ps-node-body { padding:10px 12px; display:flex; flex-direction:column; gap:8px; }
    .ps-field-label { font-size:10px; color:var(--stone); letter-spacing:1.5px; text-transform:uppercase; margin-bottom:2px; }
    .ps-input { width:100%; background:var(--mist); border:1px solid var(--border); border-radius:4px; padding:6px 8px; font-family:var(--font-b); font-size:12px; color:var(--ink); box-sizing:border-box; }
    .ps-input:focus { border-color:var(--ember); outline:none; background:#fff; }
    .ps-select { appearance:none; -webkit-appearance:none; background:var(--mist) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23999'/%3E%3C/svg%3E") no-repeat right 8px center; padding-right:24px; cursor:pointer; }
    .ps-select:focus { border-color:var(--ember); outline:none; background-color:#fff; }
    /* Prompt node rows */
    .prompt-rows { display:flex; flex-direction:column; gap:4px; max-height:150px; overflow-y:auto; }
    .prompt-row { display:flex; gap:4px; align-items:center; }
    .prompt-row input { flex:1; background:var(--mist); border:1px solid var(--border); border-radius:4px; padding:5px 7px; font-family:var(--font-b); font-size:11px; color:var(--ink); }
    .prompt-row input:focus { border-color:var(--ember); outline:none; background:#fff; }
    .prompt-del-btn { background:none; border:none; color:var(--stone); cursor:pointer; font-size:16px; line-height:1; padding:2px 5px; flex-shrink:0; }
    .prompt-del-btn:hover { color:var(--ember); }
    .add-prompt-btn { background:none; border:1px dashed var(--border); border-radius:4px; color:var(--stone); font-family:var(--font-b); font-size:11px; padding:5px 8px; cursor:pointer; width:100%; text-align:center; margin-top:2px; }
    .add-prompt-btn:hover { border-color:var(--ember); color:var(--ember); }
    /* Results node launch btn */
    .flow-node-launch-btn { background:var(--ember); color:#fff; border:none; border-radius:6px; font-family:var(--font-b); font-size:13px; font-weight:700; padding:10px 16px; cursor:pointer; width:100%; margin-top:4px; letter-spacing:0.5px; }
    .flow-node-launch-btn:hover { background:#c73d22; }
    .flow-estimate { font-size:11px; color:var(--stone); min-height:28px; line-height:1.5; }
    /* Temp display */
    .temp-display { font-family:var(--font-b); font-size:11px; color:var(--ember); font-weight:700; }
    /* Chat panel */
    .flow-chat-panel { width:300px; border-left:1px solid var(--border); display:flex; flex-direction:column; background:#fff; flex-shrink:0; }
    .flow-chat-header { background:var(--ink); color:#fff; padding:11px 14px; font-family:var(--font-b); font-size:10px; letter-spacing:2.5px; text-transform:uppercase; display:flex; align-items:center; gap:8px; flex-shrink:0; }
    .flow-chat-indicator { width:7px; height:7px; background:#4ade80; border-radius:50%; flex-shrink:0; animation:pulse 2s infinite; }
    .flow-chat-msgs { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .flow-chat-msg { max-width:95%; padding:9px 11px; border-radius:8px; font-size:12px; line-height:1.55; font-family:var(--font-b); }
    .flow-chat-msg.user { background:var(--ink); color:#fff; align-self:flex-end; border-radius:8px 8px 2px 8px; }
    .flow-chat-msg.assistant { background:var(--mist); color:var(--ink); align-self:flex-start; border-radius:8px 8px 8px 2px; }
    .flow-chat-msg pre { background:#0a0a0a; color:#e8e8e8; border-radius:4px; padding:8px 10px; font-size:11px; overflow-x:auto; margin:6px 0 0; white-space:pre-wrap; word-break:break-all; }
    .flow-chat-footer { padding:10px; border-top:1px solid var(--border); display:flex; gap:6px; flex-shrink:0; align-items:flex-end; }
    .flow-chat-footer textarea { flex:1; resize:none; border:1px solid var(--border); border-radius:6px; padding:8px; font-family:var(--font-b); font-size:12px; height:60px; box-sizing:border-box; }
    .flow-chat-footer textarea:focus { border-color:var(--ember); outline:none; }
    .flow-send-btn { background:var(--ember); color:#fff; border:none; border-radius:6px; padding:0 13px; height:60px; cursor:pointer; font-size:18px; flex-shrink:0; }
    .flow-send-btn:hover { background:#c73d22; }
</style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.js"></script>
</head>
<body>
<div class="app">
  <nav class="nav">
    <div class="nav-logo" onclick="showPage('landing')">
      <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="11" cy="11" r="10" stroke="#e84d2f" stroke-width="1.5"/>
        <circle cx="11" cy="11" r="5.5" stroke="#e84d2f" stroke-width="1.5"/>
        <circle cx="11" cy="11" r="1.5" fill="#e84d2f"/>
        <line x1="11" y1="1" x2="11" y2="4.5" stroke="#e84d2f" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="11" y1="17.5" x2="11" y2="21" stroke="#e84d2f" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="1" y1="11" x2="4.5" y2="11" stroke="#e84d2f" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="17.5" y1="11" x2="21" y2="11" stroke="#e84d2f" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span class="nav-logo-text">PathScore</span>
      <span class="nav-dot"></span>
    </div>
    <div class="nav-links">
      <span class="nav-link" data-page="landing" onclick="showPage('landing')">Home</span>
      <span class="nav-link active" data-page="home" onclick="showPage('home')">Benchmarks</span>
      <span class="nav-link" data-page="about" onclick="showPage('about')">Methodology</span>
      <span class="nav-link" data-page="extensions" onclick="showPage('extensions')">Extensions</span>
      <span class="nav-link" data-page="flow" onclick="showPage('flow')">Flow</span>
    </div>
  </nav>
  <main class="main">

    <!-- LANDING -->
    <div id="page-landing" class="page active">
      <!-- Hero -->
      <div class="landing-hero">
        <div class="landing-hero-left">
          <div class="landing-eyebrow">SVG Generation Benchmark</div>
          <h1 class="landing-h1">Measure what<br>models can<br><span class="ember">actually draw.</span></h1>
          <p class="landing-sub">PathScore runs any set of OpenRouter LLMs against a prompt dataset. A VLM judge compares outputs pairwise. ELO rankings tell you who actually wins.</p>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:32px;">
            <button class="btn btn-accent" style="font-size:14px;padding:12px 24px;" onclick="startNewBenchmark()">+ New Benchmark</button>
            <button class="btn btn-outline" style="font-size:14px;padding:12px 24px;" onclick="showPage('home')">View Benchmarks</button>
          </div>
        </div>
        <div class="landing-hero-right">
          <div class="landing-crosshair">
            <svg viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;">
              <circle cx="160" cy="160" r="140" stroke="#e84d2f" stroke-width="1" fill="none" opacity="0.15"/>
              <circle cx="160" cy="160" r="100" stroke="#e84d2f" stroke-width="1" fill="none" opacity="0.25"/>
              <circle cx="160" cy="160" r="60" stroke="#e84d2f" stroke-width="1.5" fill="none" opacity="0.5"/>
              <circle cx="160" cy="160" r="20" stroke="#e84d2f" stroke-width="2" fill="none"/>
              <circle cx="160" cy="160" r="5" fill="#e84d2f"/>
              <line x1="160" y1="0" x2="160" y2="130" stroke="#e84d2f" stroke-width="1.5" opacity="0.6"/>
              <line x1="160" y1="190" x2="160" y2="320" stroke="#e84d2f" stroke-width="1.5" opacity="0.6"/>
              <line x1="0" y1="160" x2="130" y2="160" stroke="#e84d2f" stroke-width="1.5" opacity="0.6"/>
              <line x1="190" y1="160" x2="320" y2="160" stroke="#e84d2f" stroke-width="1.5" opacity="0.6"/>
              <!-- tick marks -->
              <line x1="155" y1="20" x2="165" y2="20" stroke="#e84d2f" stroke-width="1" opacity="0.4"/>
              <line x1="155" y1="300" x2="165" y2="300" stroke="#e84d2f" stroke-width="1" opacity="0.4"/>
              <line x1="20" y1="155" x2="20" y2="165" stroke="#e84d2f" stroke-width="1" opacity="0.4"/>
              <line x1="300" y1="155" x2="300" y2="165" stroke="#e84d2f" stroke-width="1" opacity="0.4"/>
            </svg>
          </div>
          <div class="landing-stat-chips" id="landing-stats">
            <div class="stat-chip"><span class="stat-chip-n" id="stat-gens">—</span><span class="stat-chip-l">SVGs generated</span></div>
            <div class="stat-chip"><span class="stat-chip-n" id="stat-cmps">—</span><span class="stat-chip-l">Comparisons run</span></div>
            <div class="stat-chip"><span class="stat-chip-n" id="stat-models">—</span><span class="stat-chip-l">Models tested</span></div>
            <div class="stat-chip"><span class="stat-chip-n" id="stat-runs">—</span><span class="stat-chip-l">Benchmarks complete</span></div>
          </div>
        </div>
      </div>

      <!-- Latest leaderboard -->
      <div id="landing-leaderboard-wrap" style="display:none;margin-bottom:64px;">
        <div style="display:flex;align-items:baseline;gap:16px;margin-bottom:24px;">
          <h2>Latest Results</h2>
          <span id="landing-run-name" style="font-size:13px;color:var(--stone);"></span>
          <button class="btn btn-ghost btn-sm" style="margin-left:auto;" id="landing-view-btn" onclick="">Full Results →</button>
        </div>
        <div id="landing-leaderboard"></div>
      </div>

      <!-- Sample SVG grid -->
      <div id="landing-svgs-wrap" style="display:none;margin-bottom:64px;">
        <h2 style="margin-bottom:24px;">Sample Outputs</h2>
        <div class="landing-svg-grid" id="landing-svg-grid"></div>
      </div>

      <!-- How it works -->
      <div style="margin-bottom:64px;">
        <h2 style="margin-bottom:32px;">How it works</h2>
        <div class="landing-steps">
          <div class="landing-step">
            <div class="landing-step-n">01</div>
            <div>
              <div class="landing-step-title">Configure</div>
              <div class="landing-step-body">Pick models from 400+ on OpenRouter. Write prompts or generate them with AI. Choose a VLM judge and reasoning effort per model.</div>
            </div>
          </div>
          <div class="landing-step">
            <div class="landing-step-n">02</div>
            <div>
              <div class="landing-step-title">Run</div>
              <div class="landing-step-body">All N×M generations fire in parallel. Judging begins the moment any two models complete a prompt — no waiting for stragglers.</div>
            </div>
          </div>
          <div class="landing-step">
            <div class="landing-step-n">03</div>
            <div>
              <div class="landing-step-title">Judge</div>
              <div class="landing-step-body">A/B positions randomized each pair to eliminate position bias. Run 1–5 judge passes per pair to reduce noise.</div>
            </div>
          </div>
          <div class="landing-step">
            <div class="landing-step-n">04</div>
            <div>
              <div class="landing-step-title">Results</div>
              <div class="landing-step-body">ELO leaderboard, win-rate heatmap, and searchable comparison browser. Export as JSON, HTML, or PDF.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Feature grid -->
      <div style="margin-bottom:64px;">
        <h2 style="margin-bottom:24px;">What you can test</h2>
        <div class="landing-features">
          <div class="landing-feature">
            <div class="landing-feature-icon lf-black">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
            </div>
            <div class="landing-feature-title">Standard benchmark</div>
            <div class="landing-feature-body">Generate from prompt, judge pairwise. The baseline for raw SVG quality across any set of models.</div>
          </div>
          <div class="landing-feature">
            <div class="landing-feature-icon lf-ember">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
            </div>
            <div class="landing-feature-title">Feedback iteration</div>
            <div class="landing-feature-body">Winner + critique goes back to models for a second pass. Tests whether models can actually improve on feedback.</div>
          </div>
          <div class="landing-feature">
            <div class="landing-feature-icon lf-black">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </div>
            <div class="landing-feature-title">Image to SVG</div>
            <div class="landing-feature-body">Give models a reference image and ask them to reproduce it in SVG. Tests pixel-to-vector fidelity.</div>
          </div>
          <div class="landing-feature">
            <div class="landing-feature-icon lf-black">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </div>
            <div class="landing-feature-title">SVG editing</div>
            <div class="landing-feature-body">Provide an SVG and an edit instruction. Who applies it most accurately? Tests instruction following.</div>
          </div>
          <div class="landing-feature">
            <div class="landing-feature-icon lf-ember">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div class="landing-feature-title">Human evaluation</div>
            <div class="landing-feature-body">You judge alongside LLMs. Tracks human-AI agreement rate and surfaces disagreements.</div>
          </div>
          <div class="landing-feature" style="background:var(--ink);border-color:var(--ink);">
            <div style="color:white;">
              <div style="font-family:var(--font-h);font-weight:800;font-size:22px;margin-bottom:8px;">400+</div>
              <div style="font-size:13px;font-weight:600;color:rgba(255,255,255,0.85);margin-bottom:6px;">models available</div>
              <div style="font-size:12px;color:rgba(255,255,255,0.5);">Any model on OpenRouter — set reasoning effort per model instance.</div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- HOME (Benchmarks list) -->
    <div id="page-home" class="page">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;padding-top:8px;">
        <h2>Your Benchmarks</h2>
        <div style="display:flex;gap:10px;align-items:center;">
          <span id="runs-count" class="stone" style="font-size:12px;"></span>
          <button class="btn btn-accent btn-sm" onclick="startNewBenchmark()">+ New</button>
          <label class="btn btn-outline btn-sm" style="cursor:pointer">Import<input type="file" accept=".json" style="display:none" onchange="importResults(event)"></label>
        </div>
      </div>
      <div id="runs-list" class="run-list"></div>
    </div>

    <!-- CONFIGURE -->
    <div id="page-configure" class="page">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:40px;">
        <button class="btn btn-ghost btn-sm" onclick="showPage('home')">&#8592; Back</button>
        <h1 id="cfg-title">New Benchmark</h1>
      </div>
      <div class="config-layout">
        <div class="config-sidebar">
          <div class="config-steps">
            <div class="config-step active" onclick="showStep(0)" data-step="0"><div class="config-step-num">0</div>Mode</div>
            <div class="config-step" onclick="showStep(1)" data-step="1"><div class="config-step-num">1</div>Models</div>
            <div class="config-step" onclick="showStep(2)" data-step="2"><div class="config-step-num">2</div>Prompts</div>
            <div class="config-step" onclick="showStep(3)" data-step="3"><div class="config-step-num">3</div>Judge</div>
            <div class="config-step" onclick="showStep(4)" data-step="4"><div class="config-step-num">4</div>Settings</div>
          </div>
          <hr class="divider">
          <div style="font-size:12px;color:var(--stone);line-height:1.8;">
            <div id="sum-mode">Mode: standard</div>
            <div id="sum-models">0 models</div>
            <div id="sum-prompts">0 prompts</div>
            <div id="sum-judge">No judge set</div>
          </div>
          <hr class="divider">
          <button class="btn btn-accent" style="width:100%" onclick="saveAndRun()">Run Benchmark &#8594;</button>
          <button class="btn btn-outline" style="width:100%;margin-top:8px" onclick="saveDraft()">Save Draft</button>
        </div>
        <div>
          <!-- Step 0: Mode -->
          <div class="config-panel active" id="panel-0">
            <div style="margin-bottom:32px;"><h2>Select Mode</h2><p class="stone" style="font-size:13px;margin-top:6px;">Choose how this benchmark will operate.</p></div>
            <div class="mode-cards" id="mode-cards-container"></div>
            <!-- Feedback iteration extra config -->
            <div id="iter-model-section" style="display:none;margin-top:24px;">
              <h3 style="margin-bottom:8px;">Iteration Models</h3>
              <p style="font-size:12px;color:var(--stone);margin-bottom:12px;">These models will generate improved SVGs based on feedback. Leave empty to reuse main models.</p>
              <div class="model-search-wrap">
                <svg class="model-search-icon" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" class="model-search-input" id="iter-model-search" placeholder="Search iteration models..." oninput="searchIterModels(this.value)" onfocus="showIterModelDD()">
              </div>
              <div class="model-dropdown" id="iter-model-dd" style="display:none"><div id="iter-model-options"></div></div>
              <div id="sel-iter-models" class="sel-models"></div>
            </div>
            <!-- Human eval extra config -->
            <div id="human-eval-section" style="display:none;margin-top:24px;">
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;">
                <input type="checkbox" id="human-llm-judge" checked style="width:auto;">
                Also run LLM judge alongside human (track agreement)
              </label>
            </div>
          </div>

          <!-- Step 1: Models -->
          <div class="config-panel" id="panel-1">
            <div style="margin-bottom:32px;"><h2>Select Models</h2><p class="stone" style="font-size:13px;margin-top:6px;">Choose OpenRouter models to benchmark. Search by name or ID.</p></div>
            <div class="model-search-wrap">
              <svg class="model-search-icon" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" class="model-search-input" id="model-search" placeholder="Search models..." oninput="searchModels(this.value)" onfocus="showModelDD()">
            </div>
            <div class="model-dropdown" id="model-dd" style="display:none">
              <div id="model-options"></div>
              <div class="load-more" id="model-load-more" onclick="loadMoreModels()" style="display:none">Load more</div>
            </div>
            <div id="sel-models" class="sel-models"></div>
            <button class="adv-toggle" onclick="toggleAdv('adv-gen',this)">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
              Advanced generation settings
            </button>
            <div class="adv-section" id="adv-gen">
              <div class="field"><label class="label">Temperature</label><div class="rr"><input type="range" id="gen-temp" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('gen-temp-v').textContent=this.value"><span class="rv" id="gen-temp-v">0.7</span></div></div>
            </div>
          </div>

          <!-- Step 2: Prompts -->
          <div class="config-panel" id="panel-2">
            <div style="margin-bottom:32px;"><h2>Prompt Dataset</h2><p class="stone" style="font-size:13px;margin-top:6px;">Each model receives every prompt. Results scale as N&#215;(N-1)/2 pairs per prompt.</p></div>
            <div id="prompt-standard-section">
              <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button class="btn btn-outline btn-sm" onclick="loadDefaultPrompts()">Load defaults</button>
                <button class="btn btn-outline btn-sm" onclick="addPromptRow()">+ Add prompt</button>
                <button class="btn btn-ghost btn-sm" onclick="clearPrompts()" style="margin-left:auto">Clear all</button>
              </div>
              <div id="prompt-list" class="prompt-list"></div>
              <div class="ai-gen-box">
                <h3 style="font-size:13px;margin-bottom:12px;">AI-Assisted Generation</h3>
                <p style="font-size:12px;color:var(--stone);margin-bottom:12px;">Describe what you want to test and we will generate relevant prompts.</p>
                <div class="ai-gen-row">
                  <input type="text" id="ai-gen-desc" placeholder="e.g. logo design challenges..." style="flex:1">
                  <input type="number" id="ai-gen-count" value="8" min="1" max="20" style="width:70px">
                  <button class="btn btn-primary btn-sm" onclick="generatePrompts()" id="ai-gen-btn">Generate</button>
                </div>
              </div>
            </div>
            <!-- Image to SVG prompts -->
            <div id="prompt-image-section" style="display:none;">
              <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button class="btn btn-outline btn-sm" onclick="addImagePromptRow()">+ Add image prompt</button>
                <button class="btn btn-ghost btn-sm" onclick="clearPrompts()" style="margin-left:auto">Clear all</button>
              </div>
              <div id="image-prompt-list" class="prompt-list"></div>
            </div>
            <!-- SVG Editing prompts -->
            <div id="prompt-editing-section" style="display:none;">
              <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button class="btn btn-outline btn-sm" onclick="addEditPromptRow()">+ Add edit task</button>
                <button class="btn btn-ghost btn-sm" onclick="clearPrompts()" style="margin-left:auto">Clear all</button>
              </div>
              <div id="edit-prompt-list" class="prompt-list"></div>
            </div>
          </div>

          <!-- Step 3: Judge -->
          <div class="config-panel" id="panel-3">
            <div style="margin-bottom:32px;"><h2>Judge Configuration</h2><p class="stone" style="font-size:13px;margin-top:6px;">Select a vision-capable model to evaluate pairwise SVG comparisons.</p></div>
            <div class="field">
              <label class="label">Judge Model</label>
              <div class="model-search-wrap">
                <svg class="model-search-icon" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" class="model-search-input" id="judge-search" placeholder="Search judge model..." oninput="searchJudge(this.value)" onfocus="showJudgeDD()">
              </div>
              <div class="model-dropdown" id="judge-dd" style="display:none"><div id="judge-options"></div></div>
              <div id="judge-sel" style="margin-top:8px;font-size:12px;color:var(--stone);"></div>
            </div>
            <button class="adv-toggle" onclick="toggleAdv('adv-judge',this)">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
              Advanced judge settings
            </button>
            <div class="adv-section" id="adv-judge">
              <div class="field">
                <label class="label">Judge Runs Per Pair</label>
                <div class="rr"><input type="range" id="judge-runs" min="1" max="5" step="1" value="1" oninput="document.getElementById('judge-runs-v').textContent=this.value+(this.value>1?' runs':' run')"><span class="rv" id="judge-runs-v">1 run</span></div>
              </div>
            </div>
          </div>

          <!-- Step 4: Settings -->
          <div class="config-panel" id="panel-4">
            <div style="margin-bottom:32px;"><h2>Benchmark Settings</h2></div>
            <div class="field"><label class="label">Benchmark Name</label><input type="text" id="bench-name" placeholder="e.g. Small models - Feb 2026"></div>
            <hr class="divider">
            <div style="margin-bottom:24px;">
              <div style="font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);margin-bottom:12px;">Saved Configs</div>
              <div style="display:flex;gap:8px;margin-bottom:12px;">
                <input type="text" id="save-cfg-name" placeholder="Config name..." style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px;">
                <button class="btn btn-outline btn-sm" onclick="saveConfig()">Save Config</button>
              </div>
              <div id="saved-configs-list" style="display:flex;flex-direction:column;gap:6px;"></div>
            </div>
            <hr class="divider">
            <div id="bench-estimate" style="background:var(--mist);border-radius:6px;padding:20px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RUN -->
    <div id="page-run" class="page">
      <div class="run-header">
        <div>
          <button class="btn btn-ghost btn-sm" onclick="showPage('home')" style="margin-bottom:8px">&#8592; Back</button>
          <h2 id="run-title">Running...</h2>
          <div id="run-status" style="margin-top:6px;font-size:12px;display:flex;align-items:center;gap:6px;"></div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-primary btn-sm" onclick="viewResults(currentRunId)" id="btn-view-results" style="display:none">View Results &#8594;</button>
          <button class="btn btn-outline btn-sm" id="btn-stop" onclick="stopRun()">Stop</button>
          <a id="btn-export" class="btn btn-outline btn-sm" href="#">Export JSON</a>
        </div>
      </div>
      <div class="stats-row">
        <div class="stat-box"><div class="stat-label">Generations</div><div class="stat-val" id="st-gen-done">0</div><div class="stat-sub" id="st-gen-total">of -- total</div></div>
        <div class="stat-box"><div class="stat-label">Comparisons</div><div class="stat-val" id="st-cmp-done">0</div><div class="stat-sub" id="st-cmp-total">of -- total</div></div>
        <div class="stat-box"><div class="stat-label">Errors</div><div class="stat-val" id="st-errors" style="color:var(--ember)">0</div><div class="stat-sub">gen + judge</div></div>
        <div class="stat-box"><div class="stat-label">Elapsed</div><div class="stat-val" id="st-elapsed">0:00</div><div class="stat-sub">mm:ss</div></div>
      </div>
      <div class="pbar" style="margin-bottom:32px;"><div class="pbar-fill" id="run-pbar" style="width:0%"></div></div>
      <div class="run-cols">
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <h3>Live Feed</h3>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('ev-feed').innerHTML=''">Clear</button>
          </div>
          <div class="event-feed" id="ev-feed"></div>
        </div>
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <h3>Generated SVGs</h3>
            <span id="svg-count" style="font-size:11px;color:var(--stone);">0 rendered</span>
          </div>
          <div class="svg-grid" id="svg-grid"></div>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="page-results" class="page">
      <button class="btn btn-ghost btn-sm" onclick="showPage('home')" style="margin-bottom:16px">&#8592; Back</button>
      <h1 id="res-title">Results</h1>
      <p id="res-sub" class="stone" style="margin-top:8px;font-size:13px;margin-bottom:32px;"></p>
      <div class="export-bar" id="export-bar">
        <span class="export-lbl">Export:</span>
        <button class="btn btn-outline btn-sm" onclick="exportJSON()">JSON dataset</button>
        <button class="btn btn-outline btn-sm" onclick="exportHTML()">HTML report</button>
        <button class="btn btn-outline btn-sm" onclick="window.print()">PDF (print)</button>
      </div>
      <div class="tabs" id="result-tabs">
        <div class="tab active" onclick="switchTab('lb',this)">ELO Leaderboard</div>
        <div class="tab" onclick="switchTab('hm',this)">Win Rate Heatmap</div>
        <div class="tab" onclick="switchTab('cmps',this)">Comparisons</div>
        <div class="tab" onclick="switchTab('out',this)">All Outputs</div>
        <div class="tab" id="tab-iter-btn" style="display:none" onclick="switchTab('iter',this)">Iteration Results</div>
        <div class="tab" id="tab-agree-btn" style="display:none" onclick="switchTab('agree',this)">Judge Agreement</div>
        <div class="tab" id="tab-human-btn" style="display:none" onclick="showPage('human-judge')">Human Judge &#8594;</div>
        <div class="tab" id="tab-je-btn" style="display:none" onclick="switchTab('je-lb',this)">⚖️ Judge ELO</div>
        <div class="tab" id="tab-je-vote-btn" style="display:none" onclick="showPage('judge-eval')">Vote on Pairs &#8594;</div>
      </div>
      <div class="tab-panel active" id="tab-lb">
        <table class="lb"><thead><tr><th style="width:40px">#</th><th>Model</th><th>ELO Score</th><th>Win Rate</th><th>W / L / T</th><th>Avg Score</th></tr></thead><tbody id="lb-body"></tbody></table>
      </div>
      <div class="tab-panel" id="tab-hm">
        <p style="font-size:13px;color:var(--stone);margin-bottom:16px;">Row = challenger model (A), column = opponent model (B). Cell = challenger win rate.</p>
        <div class="hm-wrap" id="hm-wrap"></div>
      </div>
      <div class="tab-panel" id="tab-cmps">
        <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
          <input type="text" id="cmp-filter" placeholder="Filter by model or prompt..." style="max-width:300px" oninput="filterCmps(this.value)">
          <select id="cmp-wf" onchange="filterCmps(document.getElementById('cmp-filter').value)" style="max-width:160px"><option value="">All outcomes</option><option value="A">A wins</option><option value="B">B wins</option><option value="tie">Tie</option></select>
        </div>
        <div class="cmp-grid" id="cmp-grid"></div>
        <div id="cmp-more" style="text-align:center;margin-top:20px;"></div>
      </div>
      <div class="tab-panel" id="tab-out">
        <div style="margin-bottom:16px;display:flex;gap:10px;align-items:center;">
          <select id="out-mf" onchange="renderOutputs()" style="max-width:240px"><option value="">All models</option></select>
          <select id="out-pf" onchange="renderOutputs()" style="max-width:280px"><option value="">All prompts</option></select>
        </div>
        <div class="outputs-grid" id="out-grid"></div>
      </div>
      <div class="tab-panel" id="tab-iter">
        <div id="iter-lb-wrap" style="margin-bottom:32px;"></div>
        <div id="iter-cmp-grid" class="cmp-grid"></div>
      </div>
      <div class="tab-panel" id="tab-agree">
        <div id="agree-wrap"></div>
      </div>
      <div class="tab-panel" id="tab-je-lb">
        <div id="je-lb-wrap"></div>
      </div>
    </div>

    <!-- JUDGE EVAL VOTING PAGE -->
    <div id="page-judge-eval" class="page">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
        <button class="btn btn-ghost btn-sm" onclick="showPage('results')">&#8592; Back to Results</button>
        <h2 style="margin:0;">⚖️ Judge Evaluation</h2>
        <span id="je-progress-label" style="font-size:12px;color:var(--stone);margin-left:auto;"></span>
      </div>
      <div class="je-progress-bar"><div class="je-progress-fill" id="je-progress-fill" style="width:0%"></div></div>
      <div id="je-prompt" class="je-prompt"></div>
      <div class="je-svgs" id="je-svgs">
        <div class="je-panel">
          <div class="je-panel-label">SVG A</div>
          <img class="je-svg-img" id="je-img-a" src="" alt="SVG A">
          <button class="je-vote-btn je-vote-a" id="je-btn-a" onclick="jeVote('A')">A is Better <kbd>←</kbd> <kbd>1</kbd></button>
        </div>
        <div class="je-panel">
          <div class="je-panel-label">SVG B</div>
          <img class="je-svg-img" id="je-img-b" src="" alt="SVG B">
          <button class="je-vote-btn je-vote-b" id="je-btn-b" onclick="jeVote('B')">B is Better <kbd>→</kbd> <kbd>2</kbd></button>
        </div>
      </div>
      <div style="text-align:center;margin:16px 0;">
        <button class="je-vote-bad" id="je-btn-bad" onclick="jeVote('both_bad')">Both Bad — Neither is good <kbd>↓</kbd> <kbd>3</kbd></button>
      </div>
      <div id="je-reveal" class="je-reveal" style="display:none"></div>
      <div id="je-done" style="display:none;text-align:center;padding:48px 0;">
        <h3>All pairs rated!</h3>
        <p style="color:var(--stone);margin:12px 0 24px">See how judges compared to your verdicts.</p>
        <button class="btn btn-primary" onclick="showPage('results');switchTab('je-lb',document.getElementById('tab-je-btn'))">View Judge ELO &#8594;</button>
      </div>
    </div>

    <!-- HUMAN JUDGE PAGE -->
    <div id="page-human-judge" class="page">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:32px;">
        <button class="btn btn-ghost btn-sm" onclick="showPage('results')">&#8592; Back to Results</button>
        <h2>Human Evaluation</h2>
        <span id="human-progress" style="font-size:12px;color:var(--stone);margin-left:auto;"></span>
      </div>
      <div id="human-judge-container" class="human-judge-panel"></div>
    </div>

    <!-- ABOUT -->
    <div id="page-about" class="page">

      <!-- Hero -->
      <div class="about-hero">
        <div style="font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--stone);margin-bottom:16px;">Methodology</div>
        <h1 style="max-width:640px;">A transparent framework for comparing SVG generation quality across LLMs</h1>
        <div style="display:flex;gap:32px;margin-top:32px;flex-wrap:wrap;">
          <div><div style="font-family:var(--font-h);font-weight:800;font-size:36px;line-height:1;">N×M</div><div style="font-size:12px;color:var(--stone);margin-top:4px;">parallel generations</div></div>
          <div style="width:1px;background:var(--border);"></div>
          <div><div style="font-family:var(--font-h);font-weight:800;font-size:36px;line-height:1;">N(N−1)/2</div><div style="font-size:12px;color:var(--stone);margin-top:4px;">unique pairs per prompt</div></div>
          <div style="width:1px;background:var(--border);"></div>
          <div><div style="font-family:var(--font-h);font-weight:800;font-size:36px;line-height:1;">K=32</div><div style="font-size:12px;color:var(--stone);margin-top:4px;">ELO K-factor</div></div>
          <div style="width:1px;background:var(--border);"></div>
          <div><div style="font-family:var(--font-h);font-weight:800;font-size:36px;line-height:1;">1000</div><div style="font-size:12px;color:var(--stone);margin-top:4px;">starting ELO score</div></div>
        </div>
      </div>

      <!-- Pipeline -->
      <div class="about-sec">
        <div class="about-sec-label">The pipeline</div>
        <h2>Four stages, fully parallelized</h2>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;margin:32px 0;position:relative;">
          <!-- connector line -->
          <div style="position:absolute;top:28px;left:10%;right:10%;height:2px;background:var(--border);z-index:0;"></div>
          <div class="pipe-step">
            <div class="pipe-num">01</div>
            <div class="pipe-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
            </div>
            <div class="pipe-title">Prompt Dataset</div>
            <div class="pipe-body">M prompts defined by you, or AI-generated. Each model receives every prompt.</div>
          </div>
          <div class="pipe-step">
            <div class="pipe-num">02</div>
            <div class="pipe-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M9 12l2 2 4-4"/></svg>
            </div>
            <div class="pipe-title">SVG Generation</div>
            <div class="pipe-body">All N×M generations fire in parallel via OpenRouter. No waiting between models.</div>
          </div>
          <div class="pipe-step">
            <div class="pipe-num">03</div>
            <div class="pipe-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 6h18M3 12h18M3 18h18"/><circle cx="7" cy="6" r="2" fill="currentColor" stroke="none"/><circle cx="17" cy="12" r="2" fill="currentColor" stroke="none"/><circle cx="10" cy="18" r="2" fill="currentColor" stroke="none"/></svg>
            </div>
            <div class="pipe-title">Pairwise Judging</div>
            <div class="pipe-body">A VLM judge sees both SVGs rendered as PNG. A/B positions are randomized each pair to eliminate position bias.</div>
          </div>
          <div class="pipe-step">
            <div class="pipe-num">04</div>
            <div class="pipe-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
            </div>
            <div class="pipe-title">ELO Rankings</div>
            <div class="pipe-body">Each judgment updates both models' ratings. Win/loss/tie maps to 1/0/0.5 for the ELO formula.</div>
          </div>
        </div>
      </div>

      <!-- Pairing strategy -->
      <div class="about-sec">
        <div class="about-sec-label">Pairing strategy</div>
        <h2>Every model faces every other model</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-top:24px;">
          <div>
            <p style="color:var(--stone);line-height:1.8;">For N models and M prompts, PathScore creates all unique pairings — no round-robin shortcuts. A/B position is randomly assigned per pair to prevent the judge from favoring whichever appears first.</p>
            <p style="color:var(--stone);line-height:1.8;">With 4 models and 5 prompts at 2 judge runs per pair, that's <strong style="color:var(--ink);">60 total comparisons</strong> — all fired in parallel.</p>
            <div class="formula" style="margin-top:20px;">
              comparisons = M &times; <sup>N(N−1)</sup>/<sub>2</sub> &times; R
            </div>
            <div style="font-size:11px;color:var(--stone);margin-top:8px;">M = prompts &nbsp;·&nbsp; N = models &nbsp;·&nbsp; R = judge runs per pair</div>
          </div>
          <!-- Visual pairing diagram -->
          <div style="background:var(--mist);border-radius:6px;padding:24px;">
            <div style="font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);margin-bottom:20px;">4 models → 6 unique pairs</div>
            <div style="display:flex;gap:12px;justify-content:center;margin-bottom:20px;">
              <div class="pair-node" id="pn-a">A</div>
              <div class="pair-node" id="pn-b">B</div>
              <div class="pair-node" id="pn-c">C</div>
              <div class="pair-node" id="pn-d">D</div>
            </div>
            <svg viewBox="0 0 220 90" style="width:100%;display:block;" xmlns="http://www.w3.org/2000/svg">
              <!-- nodes at x: 20,73,127,200  y:10 -->
              <line x1="27" y1="15" x2="66" y2="15" stroke="#0a0a0a" stroke-width="1.5"/>
              <line x1="27" y1="15" x2="120" y2="15" stroke="#0a0a0a" stroke-width="1.5"/>
              <line x1="27" y1="15" x2="193" y2="15" stroke="#0a0a0a" stroke-width="1.5"/>
              <line x1="73" y1="15" x2="120" y2="15" stroke="#e84d2f" stroke-width="1.5"/>
              <line x1="73" y1="15" x2="193" y2="15" stroke="#e84d2f" stroke-width="1.5"/>
              <line x1="127" y1="15" x2="193" y2="15" stroke="#0a0a0a" stroke-width="1.5" stroke-dasharray="4,3"/>
              <text x="110" y="55" text-anchor="middle" font-size="11" fill="#888" font-family="'IBM Plex Mono',monospace">AB · AC · AD · BC · BD · CD</text>
              <text x="110" y="75" text-anchor="middle" font-size="11" fill="#e84d2f" font-family="'IBM Plex Mono',monospace">6 pairs &nbsp;=&nbsp; 4×3 / 2</text>
            </svg>
          </div>
        </div>
      </div>

      <!-- ELO -->
      <div class="about-sec">
        <div class="about-sec-label">Rating system</div>
        <h2>ELO: a chess rating system applied to SVG</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-top:24px;">
          <div>
            <p style="color:var(--stone);line-height:1.8;">Every model starts at 1000. After each comparison, both models' scores update based on the expected vs actual result. Upsets move the needle more than expected wins.</p>
            <div class="formula" style="margin-top:20px;">
              E<sub>A</sub> = 1 / (1 + 10<sup>(R<sub>B</sub> − R<sub>A</sub>) / 400</sup>)
            </div>
            <div style="font-size:11px;color:var(--stone);margin-top:8px;">E<sub>A</sub> = expected score for A &nbsp;·&nbsp; K = 32</div>
            <div class="formula" style="margin-top:12px;">
              R'<sub>A</sub> = R<sub>A</sub> + K × (S<sub>A</sub> − E<sub>A</sub>)
            </div>
            <div style="font-size:11px;color:var(--stone);margin-top:8px;">S<sub>A</sub> = 1 (win) · 0.5 (tie) · 0 (loss)</div>
          </div>
          <!-- ELO example -->
          <div style="background:var(--mist);border-radius:6px;padding:24px;">
            <div style="font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);margin-bottom:16px;">Example: upset scenario</div>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div>
                <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;"><span>Model A <span style="color:var(--stone);">underdog</span></span><span style="font-family:var(--font-b);">800 → <strong style="color:var(--ink);">822</strong></span></div>
                <div style="height:6px;background:white;border-radius:3px;overflow:hidden;"><div style="width:82%;height:100%;background:var(--ember);border-radius:3px;"></div></div>
              </div>
              <div>
                <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;"><span>Model B <span style="color:var(--stone);">favourite</span></span><span style="font-family:var(--font-b);">1200 → <strong style="color:var(--ink);">1178</strong></span></div>
                <div style="height:6px;background:white;border-radius:3px;overflow:hidden;"><div style="width:100%;height:100%;background:var(--border);border-radius:3px;"></div></div>
              </div>
              <div style="font-size:11px;color:var(--stone);border-top:1px solid var(--border);padding-top:12px;">A wins despite being 400 points behind. Rating swings by 22 pts. If the favourite had won, only ~10 pts would move.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modes -->
      <div class="about-sec">
        <div class="about-sec-label">Benchmark modes</div>
        <h2>Five ways to test a model</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:24px;">
          <div class="mode-info-card">
            <div class="mode-info-icon" style="background:#0a0a0a;color:white;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
            </div>
            <div class="mode-info-title">Standard</div>
            <div class="mode-info-body">Generate from prompt → pairwise judge. The baseline for raw SVG quality.</div>
          </div>
          <div class="mode-info-card">
            <div class="mode-info-icon" style="background:#e84d2f;color:white;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
            </div>
            <div class="mode-info-title">Feedback Iteration</div>
            <div class="mode-info-body">Best generation + critique → models improve. Tests refinement ability.</div>
          </div>
          <div class="mode-info-card">
            <div class="mode-info-icon" style="background:#0a0a0a;color:white;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </div>
            <div class="mode-info-title">Image to SVG</div>
            <div class="mode-info-body">Given a reference image, reproduce it as SVG. Tests pixel-to-vector accuracy.</div>
          </div>
          <div class="mode-info-card">
            <div class="mode-info-icon" style="background:#0a0a0a;color:white;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </div>
            <div class="mode-info-title">SVG Editing</div>
            <div class="mode-info-body">Given an SVG + instruction, apply the edit. Tests instruction following.</div>
          </div>
          <div class="mode-info-card">
            <div class="mode-info-icon" style="background:#e84d2f;color:white;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div class="mode-info-title">Human Evaluation</div>
            <div class="mode-info-body">You judge alongside LLMs. Tracks agreement rate between human and AI judges.</div>
          </div>
        </div>
      </div>

      <!-- Position bias -->
      <div class="about-sec">
        <div class="about-sec-label">Bias controls</div>
        <h2>How PathScore eliminates bias</h2>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:24px;">
          <div class="bias-card">
            <div class="bias-title">Position bias</div>
            <div class="bias-body">A/B order is randomized per comparison. The same pair might appear as (X vs Y) one run and (Y vs X) the next.</div>
          </div>
          <div class="bias-card">
            <div class="bias-title">Judge variance</div>
            <div class="bias-body">Run each pair through the judge 2–5 times. Majority vote determines the outcome, smoothing single-call noise.</div>
          </div>
          <div class="bias-card">
            <div class="bias-title">Prompt coverage</div>
            <div class="bias-body">Results aggregate across all prompts. A model that excels at one category can't inflate its overall ranking.</div>
          </div>
        </div>
      </div>

    </div>


    <div id="page-extensions" class="page">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div>
          <h1>Extensions</h1>
          <p class="stone" style="margin-top:6px;font-size:14px;">Customize the pipeline with provider, judge, mode, and results hooks.</p>
        </div>
        <button class="btn btn-primary" onclick="openExtModal(null)">+ New Extension</button>
      </div>
      <hr class="divider">

      <h2 style="margin-bottom:16px;">Library</h2>
      <div class="ext-grid" id="ext-library"></div>

      <hr class="divider">

      <h2 style="margin-bottom:4px;">AI Assistant</h2>
      <p class="stone" style="font-size:12px;margin-bottom:16px;">Describe what you need — the assistant will generate the extension code for you.</p>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <span class="label" style="margin:0;white-space:nowrap;">Hook type:</span>
        <select id="ai-hook-type" style="width:auto;font-size:12px;padding:6px 10px;">
          <option value="judge">judge</option>
          <option value="provider">provider</option>
          <option value="mode">mode</option>
          <option value="results">results</option>
        </select>
      </div>
      <div class="ai-chat-wrap">
        <div class="ai-chat-header">
          <div style="width:8px;height:8px;background:var(--ember);border-radius:50%;"></div>
          <span style="font-size:12px;font-weight:500;">PathScore Extension Builder · claude-sonnet-4-6</span>
          <button class="btn btn-ghost btn-sm" onclick="clearAiChat()" style="margin-left:auto;">Clear</button>
        </div>
        <div class="ai-chat-messages" id="ai-chat-messages">
          <div class="ai-msg ai-msg-assistant">Hi! I can help you build PathScore extensions. Tell me what you want to create — for example: "Build a judge that scores code correctness" or "Create a provider that calls my local Ollama instance".</div>
        </div>
        <div class="ai-chat-footer">
          <textarea id="ai-chat-input" placeholder="Describe what you want to build..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAiChat();}"></textarea>
          <button class="btn btn-primary btn-sm" onclick="sendAiChat()">Send</button>
        </div>
      </div>
    </div>

      <!-- ===== FLOW BUILDER ===== -->
      <div id="page-flow" class="page page-flow-fullbleed">
        <div class="flow-topbar">
          <div class="flow-topbar-left">
            <button class="flow-back-btn" onclick="showPage('home')">← Back</button>
            <span class="flow-title-label">Flow Builder</span>
            <span class="flow-preset-label">PRESETS</span>
            <button class="flow-preset-btn" onclick="loadFlowPreset('quick_showdown')">Quick Showdown</button>
            <button class="flow-preset-btn" onclick="loadFlowPreset('full_standard')">Full Standard</button>
            <button class="flow-preset-btn" onclick="loadFlowPreset('feedback_loop')">Feedback Loop</button>
            <button class="flow-preset-btn" onclick="loadFlowPreset('human_eval')">Human Eval</button>
            <button class="flow-preset-btn" onclick="loadFlowPreset('multi_judge')">Multi-Judge</button>
          </div>
          <div class="flow-topbar-right">
            <div class="flow-add-menu">
              <button class="flow-add-btn" onclick="toggleFlowAddMenu(event)">+ Add Node ▾</button>
              <div class="flow-add-dd" id="flow-add-dd">
                <button onclick="addFlowNode('model',200,200);toggleFlowAddMenu()">🟢 Model</button>
                <button onclick="addFlowNode('prompt',200,380);toggleFlowAddMenu()">🔵 Prompt Pack</button>
                <button onclick="addFlowNode('judge',200,540);toggleFlowAddMenu()">🟡 Judge</button>
                <button onclick="addFlowNode('runner',520,300);toggleFlowAddMenu()">🔴 Runner</button>
                <button onclick="addFlowNode('results',820,300);toggleFlowAddMenu()">🟣 Results</button>
              </div>
            </div>
            <button class="flow-clear-btn" onclick="clearFlow()">Clear</button>
            <button class="flow-launch-btn" onclick="launchFlow()">▶ Launch</button>
          </div>
        </div>
        <div class="flow-body">
          <div id="drawflow"></div>
          <div class="flow-chat-panel">
            <div class="flow-chat-header">
              <span class="flow-chat-indicator"></span>
              AI FLOW BUILDER
            </div>
            <div class="flow-chat-msgs" id="flow-chat-msgs">
              <div class="flow-chat-msg assistant">Describe a benchmark and I'll build the flow for you.<br><br>Try: <em>"Compare Claude and Gemini on 5 logo prompts"</em></div>
            </div>
            <div class="flow-chat-footer">
              <textarea id="flow-chat-input" placeholder="Describe your benchmark..." rows="3" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendFlowChat();}"></textarea>
              <button class="flow-send-btn" onclick="sendFlowChat()">↑</button>
            </div>
          </div>
        </div>
      </div>

  </main>
</div>

<!-- Extension Modal -->
<div class="modal-overlay" id="ext-modal">
  <div class="modal" style="max-width:720px;max-height:90vh;overflow-y:auto;">
    <button class="modal-close" onclick="closeExtModal()">&#10005;</button>
    <h2 style="margin-bottom:20px;" id="ext-modal-title">New Extension</h2>

    <div class="field">
      <label class="label">Name</label>
      <input type="text" id="ext-name" placeholder="My Custom Judge">
    </div>
    <div class="field">
      <label class="label">Description</label>
      <input type="text" id="ext-desc" placeholder="What this extension does">
    </div>
    <div class="grid2" style="gap:16px;">
      <div class="field">
        <label class="label">Hook Type</label>
        <select id="ext-hook-type" onchange="toggleModeFields()">
          <option value="judge">judge</option>
          <option value="provider">provider</option>
          <option value="mode">mode</option>
          <option value="results">results</option>
        </select>
      </div>
    </div>

    <div id="mode-fields" style="display:none;">
      <div class="grid2" style="gap:16px;">
        <div class="field">
          <label class="label">Mode ID (slug)</label>
          <input type="text" id="ext-mode-id" placeholder="my_custom_mode">
        </div>
        <div class="field">
          <label class="label">Mode Label</label>
          <input type="text" id="ext-mode-label" placeholder="My Custom Mode">
        </div>
      </div>
      <div class="grid2" style="gap:16px;">
        <div class="field">
          <label class="label">Icon (emoji)</label>
          <input type="text" id="ext-mode-icon" placeholder="🔧">
        </div>
        <div class="field">
          <label class="label">Short Description</label>
          <input type="text" id="ext-mode-desc" placeholder="One-line description for mode card">
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label" style="display:flex;justify-content:space-between;align-items:center;">
        <span>fn_body (JavaScript)</span>
        <button class="btn btn-ghost btn-sm" onclick="testSyntax()" style="font-size:11px;padding:3px 10px;">Test Syntax</button>
      </label>
      <textarea class="ext-code-editor" id="ext-fn-body" placeholder="return async function(genA, genB, prompt, config, helpers) {&#10;  // your code here&#10;  return { winner: 'A', model_a_score: 8, model_b_score: 6, thought_process: '', feedback: '' };&#10;};"></textarea>
      <div id="syntax-result" class="syntax-result"></div>
    </div>

    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-outline" onclick="closeExtModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveExt()">Save Extension</button>
    </div>
  </div>
</div>

<!-- SVG Modal -->
<div class="modal-overlay" id="svg-modal">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('svg-modal').classList.remove('open')">&#10005;</button>
    <h3 id="modal-model" style="margin-bottom:8px;"></h3>
    <p id="modal-prompt" style="font-size:12px;color:var(--stone);margin-bottom:16px;"></p>
    <div id="modal-img" style="border:1.5px solid var(--border);border-radius:4px;padding:16px;background:var(--mist);"></div>
    <pre id="modal-code" style="display:none;margin-top:12px;background:#f9f9f9;border:1px solid var(--border);border-radius:4px;padding:12px;font-size:11px;max-height:200px;overflow-y:auto;white-space:pre-wrap;"></pre>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn btn-outline btn-sm" onclick="document.getElementById('modal-code').style.display=document.getElementById('modal-code').style.display==='none'?'block':'none'">Toggle code</button>
      <a id="modal-dl" class="btn btn-outline btn-sm" href="#" download>Download SVG</a>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
// State
let currentRunId = null;
let sseConn = null;
let cfg = { mode:'standard', models:[], prompts:[], judge:{model:'google/gemini-3-flash-preview',runs:1}, generation:{temperature:0.7}, name:'' };
let editRunId = null;
let allModels = [];
let modelOffset = 0;
let modelQ = '';
let allIterModels = [];
let runStats = {genDone:0,genTotal:0,cmpDone:0,cmpTotal:0,errors:0};
let runStart = null;
let elapsedTmr = null;
let resultsData = null;
let allCmps = [];
let cmpPage = 0;
const CMP_PS = 24;
let humanPending = [];
let humanIdx = 0;

function toast(msg, type) {
  const el = document.createElement('div');
  el.className = 'toast' + (type ? ' '+type : '');
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}
function fmt(ms) {
  const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;
  if(h>0) return h+':'+String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0');
  return m+':'+String(ss).padStart(2,'0');
}
function sm(id) { return id.split('/').pop() || id; }
function trunc(s,n) { return s && s.length>n ? s.slice(0,n)+'...' : (s||''); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// Navigation
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page===name));
  if (name==='landing') loadLanding();
  if (name==='home') loadRuns();
  if (name==='human-judge') loadHumanJudge();
  if (name==='extensions') loadExtensions();
  if (name==='configure') renderModeCards();
  if (name==='flow') initFlowEditor();
  if (name==='judge-eval') showPage_judgeEval();
}

async function loadLanding() {
  try {
    const d = await fetch('/api/landing').then(r => r.json());
    document.getElementById('stat-gens').textContent = d.totalGens.toLocaleString();
    document.getElementById('stat-cmps').textContent = d.totalCmps.toLocaleString();
    document.getElementById('stat-models').textContent = d.totalModels.toLocaleString();
    document.getElementById('stat-runs').textContent = d.totalRuns.toLocaleString();

    if (d.leaderboard && d.leaderboard.length) {
      document.getElementById('landing-leaderboard-wrap').style.display = 'block';
      document.getElementById('landing-run-name').textContent = d.latestRun?.name || '';
      const btn = document.getElementById('landing-view-btn');
      if (d.latestRun) btn.onclick = () => viewResults(d.latestRun.id);
      const maxElo = d.leaderboard[0].rating;
      const minElo = d.leaderboard[d.leaderboard.length-1].rating;
      document.getElementById('landing-leaderboard').innerHTML = d.leaderboard.map((r,i) => {
        const pct = maxElo===minElo ? 100 : Math.round((r.rating-minElo)/(maxElo-minElo)*80+20);
        const medal = i===0?'🥇':i===1?'🥈':i===2?'🥉':'';
        return '<div class="landing-lb-row">'+
          '<div class="landing-lb-rank">'+(i+1)+'</div>'+
          '<div class="landing-lb-model" title="'+esc(r.model)+'">'+esc(r.model.split('/').pop())+' '+medal+'</div>'+
          '<div class="landing-lb-bar"><div class="landing-lb-fill" style="width:'+pct+'%"></div></div>'+
          '<div class="landing-lb-elo">'+r.rating+'</div></div>';
      }).join('');
    }

    if (d.sampleSVGs && d.sampleSVGs.length) {
      document.getElementById('landing-svgs-wrap').style.display = 'block';
      document.getElementById('landing-svg-grid').innerHTML = d.sampleSVGs.map(g =>
        '<div class="svg-thumb" onclick="showSVGModal(\''+esc(g.id)+'\',\''+esc(g.model_id)+'\',\''+esc(g.prompt_text)+'\')">'+
        '<div class="svg-thumb-img"><img src="/api/generations/'+esc(g.id)+'/svg" loading="lazy" alt=""></div>'+
        '<div class="svg-thumb-meta"><div class="svg-thumb-model">'+esc(g.model_id.split('/').pop())+'</div>'+
        '<div class="svg-thumb-prompt">'+esc(trunc(g.prompt_text,40))+'</div></div></div>'
      ).join('');
    }
  } catch(e) { /* stats not critical */ }
}

// HOME
async function loadRuns() {
  const res = await fetch('/api/runs');
  const runs = await res.json();
  const el = document.getElementById('runs-list');
  document.getElementById('runs-count').textContent = runs.length + ' benchmark' + (runs.length!==1?'s':'');
  if (!runs.length) {
    el.innerHTML = '<div class="empty-state"><h3>No benchmarks yet</h3><p>Create your first benchmark to evaluate SVG generation quality.</p></div>';
    return;
  }
  el.innerHTML = runs.map(r => {
    const total = r.genTotal + r.cmpTotal;
    const done = r.genDone + r.cmpDone;
    const pct = total > 0 ? Math.round(done/total*100) : 0;
    const date = new Date(r.created_at).toLocaleDateString();
    const genInfo = r.genTotal ? r.genDone+'/'+r.genTotal+' SVGs' : '';
    const cmpInfo = r.cmpTotal ? r.cmpDone+'/'+r.cmpTotal+' cmps' : '';
    const modeTag = r.mode && r.mode!=='standard' ? '<span style="font-size:10px;background:var(--mist);padding:2px 8px;border-radius:10px;margin-left:8px;">'+esc(r.mode.replace('_',' '))+'</span>' : '';
    const hasResults = r.status==='complete' || r.status==='running';
    const actions = (hasResults ? '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation();viewResults(\''+r.id+'\')">'+(r.status==='running'?'Partial Results':'Results')+'</button>' : '') +
      (r.status==='draft' ? '<button class="btn btn-accent btn-sm" onclick="event.stopPropagation();editAndRun(\''+r.id+'\')">Run</button>' : '') +
      '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteRun(\''+r.id+'\',this)">&#10005;</button>';
    return '<div class="run-card" onclick="openRun(\''+r.id+'\',\''+r.status+'\')">'+
      '<div><div class="run-card-name">'+esc(r.name)+modeTag+'</div>'+
      '<div class="run-card-meta"><span>'+date+'</span>'+(genInfo?'<span>'+genInfo+'</span>':'')+(cmpInfo?'<span>'+cmpInfo+'</span>':'')+'</div></div>'+
      '<div class="run-progress-col"><div class="run-progress-label"><span class="s-'+r.status+'" style="display:flex;align-items:center;"><span class="status-dot"></span>'+r.status+'</span><span>'+pct+'%</span></div><div class="pbar"><div class="pbar-fill" style="width:'+pct+'%"></div></div></div>'+
      '<div style="display:flex;gap:6px;">'+actions+'</div></div>';
  }).join('');
}

function openRun(id, status) {
  if (status==='complete' || status==='running') viewResults(id);
  else editAndRun(id);
}

async function deleteRun(id, btn) {
  btn.disabled = true;
  await fetch('/api/runs/'+id, {method:'DELETE'});
  loadRuns(); toast('Deleted');
}

// CONFIGURE
function startNewBenchmark() {
  editRunId = null;
  cfg = { mode:'standard', models:[{id:'qwen/qwen3.5-122b-a10b',reasoning_effort:null}], prompts:[], judge:{model:'google/gemini-3-flash-preview',runs:1}, generation:{temperature:0.7}, name:'Benchmark '+new Date().toLocaleDateString() };
  document.getElementById('cfg-title').textContent = 'New Benchmark';
  document.getElementById('bench-name').value = cfg.name;
  document.getElementById('judge-search').value = cfg.judge.model;
  document.getElementById('judge-sel').textContent = 'Judge: '+cfg.judge.model;
  selectMode('standard');
  showStep(0);
  renderSelModels();
  loadDefaultPrompts();
  showPage('configure');
  initModelSearch();
}

async function editAndRun(id) {
  const res = await fetch('/api/runs/'+id);
  const run = await res.json();
  editRunId = id;
  cfg = run.config;
  if (!cfg.name) cfg.name = run.name;
  if (!cfg.mode) cfg.mode = run.mode || 'standard';
  document.getElementById('cfg-title').textContent = esc(run.name);
  document.getElementById('bench-name').value = run.name;
  document.getElementById('judge-search').value = cfg.judge?.model||'';
  document.getElementById('judge-sel').textContent = 'Judge: '+(cfg.judge?.model||'none');
  document.getElementById('judge-runs').value = cfg.judge?.runs||1;
  document.getElementById('judge-runs-v').textContent = (cfg.judge?.runs||1)+' run'+((cfg.judge?.runs||1)>1?'s':'');
  selectMode(cfg.mode || 'standard');
  renderSelModels();
  renderPromptList();
  showStep(0);
  showPage('configure');
  initModelSearch();
}

function selectMode(mode) {
  cfg.mode = mode;
  document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
  const card = document.getElementById('mode-'+mode);
  if (card) card.classList.add('selected');
  document.getElementById('iter-model-section').style.display = mode==='feedback_iteration' ? 'block' : 'none';
  document.getElementById('human-eval-section').style.display = mode==='human_eval' ? 'block' : 'none';
  // Show/hide prompt sections based on mode
  if (document.getElementById('prompt-standard-section')) {
    document.getElementById('prompt-standard-section').style.display = (mode==='image_to_svg'||mode==='svg_editing') ? 'none' : 'block';
    document.getElementById('prompt-image-section').style.display = mode==='image_to_svg' ? 'block' : 'none';
    document.getElementById('prompt-editing-section').style.display = mode==='svg_editing' ? 'block' : 'none';
  }
  updateSum();
}

function showStep(idx) {
  document.querySelectorAll('.config-step').forEach((el,i) => el.classList.toggle('active',i===idx));
  document.querySelectorAll('.config-panel').forEach((el,i) => el.classList.toggle('active',i===idx));
  if (idx===4) { updateEstimate(); renderSavedConfigs(); }
  updateSum();
}

function updateSum() {
  document.getElementById('sum-mode').textContent = 'Mode: '+(cfg.mode||'standard');
  document.getElementById('sum-models').textContent = cfg.models.length+' model'+(cfg.models.length!==1?'s':'');
  document.getElementById('sum-prompts').textContent = cfg.prompts.length+' prompt'+(cfg.prompts.length!==1?'s':'');
  document.getElementById('sum-judge').textContent = cfg.judge?.model ? trunc(cfg.judge.model,30) : 'No judge';
}

function updateEstimate() {
  const N=cfg.models.length, M=cfg.prompts.length, R=cfg.judge?.runs||1;
  const gens=N*M, cmps=M*N*(N-1)/2*R;
  document.getElementById('bench-estimate').innerHTML = '<h3 style="margin-bottom:12px;">Estimate</h3>'+
    '<div class="grid3" style="gap:12px;">'+
    '<div><div style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);margin-bottom:4px;">SVG Generations</div><div style="font-family:var(--font-h);font-weight:800;font-size:24px;">'+gens+'</div></div>'+
    '<div><div style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);margin-bottom:4px;">Comparisons</div><div style="font-family:var(--font-h);font-weight:800;font-size:24px;">'+cmps+'</div></div>'+
    '<div><div style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--stone);margin-bottom:4px;">Total API Calls</div><div style="font-family:var(--font-h);font-weight:800;font-size:24px;">'+(gens+cmps)+'</div></div>'+
    '</div><p style="font-size:11px;color:var(--stone);margin-top:12px;">'+N+' model'+(N!==1?'s':'')+' x '+M+' prompt'+(M!==1?'s':'')+' + N*(N-1)/2 pairs x '+R+' judge run'+(R!==1?'s':'')+'. All requests run in parallel.</p>';
}

async function saveAndRun() {
  const name = document.getElementById('bench-name').value.trim() || 'Benchmark '+new Date().toLocaleDateString();
  cfg.name = name;
  cfg.generation.temperature = parseFloat(document.getElementById('gen-temp').value)||0.7;
  cfg.judge.runs = parseInt(document.getElementById('judge-runs').value)||1;
  if (cfg.mode === 'human_eval') cfg.human_eval_llm_judge = document.getElementById('human-llm-judge').checked;
  if (cfg.mode === 'feedback_iteration' && allIterModels.length > 0) cfg.iteration_models = allIterModels;
  if (!cfg.models.length) { toast('Add at least one model','err'); showStep(1); return; }
  if (!cfg.prompts.length) { toast('Add at least one prompt','err'); showStep(2); return; }
  if (!cfg.judge.model) { toast('Select a judge model','err'); showStep(3); return; }
  let runId;
  if (editRunId) {
    await fetch('/api/runs/'+editRunId, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,config:cfg,mode:cfg.mode})});
    runId = editRunId;
  } else {
    const res = await fetch('/api/runs', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,config:cfg,mode:cfg.mode})});
    const d = await res.json(); runId = d.id;
  }
  await fetch('/api/runs/'+runId+'/start', {method:'POST'});
  openLiveRun(runId);
}

async function saveDraft() {
  const name = document.getElementById('bench-name').value.trim() || 'Draft '+new Date().toLocaleDateString();
  cfg.name = name;
  if (editRunId) {
    await fetch('/api/runs/'+editRunId, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,config:cfg,mode:cfg.mode})});
  } else {
    const res = await fetch('/api/runs', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,config:cfg,mode:cfg.mode})});
    const d = await res.json(); editRunId = d.id;
  }
  toast('Draft saved'); loadRuns();
}

// Saved configs
function getSavedConfigs() {
  try { return JSON.parse(localStorage.getItem('pathscore_configs')||'[]'); } catch(e) { return []; }
}
function saveConfig() {
  const name = document.getElementById('save-cfg-name').value.trim() || cfg.name || 'Config '+Date.now();
  const saved = getSavedConfigs();
  saved.unshift({ name, cfg: JSON.parse(JSON.stringify(cfg)), savedAt: Date.now() });
  localStorage.setItem('pathscore_configs', JSON.stringify(saved.slice(0,20)));
  document.getElementById('save-cfg-name').value = '';
  renderSavedConfigs();
  toast('Config saved: '+name);
}
function loadConfig(idx) {
  const saved = getSavedConfigs();
  const entry = saved[idx];
  if (!entry) return;
  cfg = JSON.parse(JSON.stringify(entry.cfg));
  document.getElementById('bench-name').value = cfg.name||'';
  document.getElementById('gen-temp').value = cfg.generation?.temperature||0.7;
  document.getElementById('gen-temp-v').textContent = cfg.generation?.temperature||0.7;
  document.getElementById('judge-search').value = cfg.judge?.model||'';
  document.getElementById('judge-sel').textContent = 'Judge: '+(cfg.judge?.model||'none');
  document.getElementById('judge-runs').value = cfg.judge?.runs||1;
  document.getElementById('judge-runs-v').textContent = (cfg.judge?.runs||1)+' run'+((cfg.judge?.runs||1)>1?'s':'');
  selectMode(cfg.mode||'standard');
  renderSelModels();
  renderPromptList();
  updateSum();
  showStep(0);
  toast('Loaded: '+entry.name);
}
function deleteConfig(idx) {
  const saved = getSavedConfigs();
  saved.splice(idx,1);
  localStorage.setItem('pathscore_configs', JSON.stringify(saved));
  renderSavedConfigs();
  toast('Config deleted');
}
function renderSavedConfigs() {
  const saved = getSavedConfigs();
  const el = document.getElementById('saved-configs-list');
  if (!el) return;
  if (!saved.length) { el.innerHTML = '<p style="font-size:12px;color:var(--stone);">No saved configs yet.</p>'; return; }
  el.innerHTML = saved.map((s,i) =>
    '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--mist);border-radius:4px;">'+
    '<div style="flex:1;min-width:0;"><div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+esc(s.name)+'</div>'+
    '<div style="font-size:11px;color:var(--stone);">'+(s.cfg.models||[]).length+' models · '+(s.cfg.prompts||[]).length+' prompts · '+esc(s.cfg.mode||'standard')+'</div></div>'+
    '<button class="btn btn-outline btn-sm" onclick="loadConfig('+i+')">Load</button>'+
    '<button class="btn btn-ghost btn-sm" onclick="deleteConfig('+i+')" style="color:var(--stone);">&#215;</button></div>'
  ).join('');
}

// Model search
async function initModelSearch() {
  modelOffset=0; modelQ='';
  const res = await fetch('/api/models?limit=30&offset=0');
  const d = await res.json();
  allModels = d.models;
  renderModelOpts(d.models, d.total>30);
}
async function searchModels(q) {
  modelQ=q; modelOffset=0;
  document.getElementById('model-dd').style.display='block';
  const res = await fetch('/api/models?q='+encodeURIComponent(q)+'&limit=30&offset=0');
  const d = await res.json();
  allModels = d.models;
  renderModelOpts(d.models, d.total>30);
}
function showModelDD() {
  document.getElementById('model-dd').style.display='block';
  if (!allModels.length) initModelSearch();
}
async function loadMoreModels() {
  modelOffset += 30;
  const res = await fetch('/api/models?q='+encodeURIComponent(modelQ)+'&limit=30&offset='+modelOffset);
  const d = await res.json();
  allModels = [...allModels, ...d.models];
  renderModelOpts(allModels, (modelOffset+30)<d.total);
}
function renderModelOpts(models, hasMore) {
  const selIds = new Set(cfg.models.map(m => m.id||m));
  const counts = {};
  cfg.models.forEach(m => { const id=m.id||m; counts[id]=(counts[id]||0)+1; });
  const modelsWithMeta = models.map(m => {
    const ctxStr = m.context_length ? Math.round(m.context_length/1000)+'k' : '';
    const priceStr = m.pricing?.prompt ? '$'+(parseFloat(m.pricing.prompt)*1000000).toFixed(3)+'/M' : '';
    const meta = [ctxStr, priceStr].filter(Boolean).join(' · ');
    return { m, meta };
  });
  document.getElementById('model-options').innerHTML = modelsWithMeta.map(({m,meta}) => {
    const cnt = counts[m.id]||0;
    const badge = cnt>0 ? '<span style="margin-left:auto;background:var(--ink);color:white;font-size:10px;padding:1px 6px;border-radius:10px;flex-shrink:0;">'+cnt+'&#10003;</span>' : '';
    return '<div class="model-option'+(cnt>0?' selected':'')+'" onclick="toggleModel(\''+esc(m.id)+'\')">'+
      '<div style="min-width:0;flex:1;"><div class="model-option-id">'+esc(m.id)+'</div>'+(m.name&&m.name!==m.id?'<div style="font-size:10px;color:var(--stone);">'+esc(trunc(m.name,40))+'</div>':'')+
      '</div><div style="display:flex;align-items:center;gap:8px;"><div class="model-option-meta">'+esc(meta)+'</div>'+badge+'</div></div>';
  }).join('');
  const lm = document.getElementById('model-load-more');
  lm.style.display = hasMore ? 'block' : 'none';
}
function toggleModel(id) {
  // Always add a new instance — duplicates with different reasoning effort are allowed
  cfg.models.push({id, reasoning_effort:null});
  renderSelModels();
  // Re-render opts but keep scroll position in the dropdown
  const dd = document.getElementById('model-options');
  const scrollTop = dd.scrollTop;
  const lm = document.getElementById('model-load-more');
  renderModelOpts(allModels, lm.style.display!=='none');
  dd.scrollTop = scrollTop;
  updateSum();
}
function renderSelModels() {
  const el = document.getElementById('sel-models');
  if (!cfg.models.length) { el.innerHTML = '<p style="font-size:12px;color:var(--stone);">No models selected.</p>'; return; }
  el.innerHTML = cfg.models.map((m,i) => {
    const id = m.id||m;
    return '<div class="sel-model-row">'+
      '<span class="sel-model-id" title="'+esc(id)+'">'+esc(id)+'</span>'+
      '<select class="reasoning-sel" onchange="cfg.models['+i+'].reasoning_effort=this.value||null" title="Reasoning effort">'+
      '<option value=""'+((!m.reasoning_effort)?' selected':'')+'>Default</option>'+
      '<option value="low"'+(m.reasoning_effort==='low'?' selected':'')+'>Low</option>'+
      '<option value="medium"'+(m.reasoning_effort==='medium'?' selected':'')+'>Medium</option>'+
      '<option value="high"'+(m.reasoning_effort==='high'?' selected':'')+'>High</option>'+
      '</select><button class="rm-btn" onclick="cfg.models.splice('+i+',1);renderSelModels();updateSum()">&#215;</button></div>';
  }).join('');
}

// Iteration models
async function searchIterModels(q) {
  document.getElementById('iter-model-dd').style.display='block';
  const res = await fetch('/api/models?q='+encodeURIComponent(q)+'&limit=20&offset=0');
  const d = await res.json();
  renderIterModelOpts(d.models);
}
function showIterModelDD() {
  document.getElementById('iter-model-dd').style.display='block';
  if (!document.getElementById('iter-model-options').children.length) searchIterModels('');
}
function renderIterModelOpts(models) {
  const selIds = allIterModels.map(m => m.id||m);
  document.getElementById('iter-model-options').innerHTML = models.map(m =>
    '<div class="model-option'+(selIds.includes(m.id)?' selected':'')+'" onclick="toggleIterModel(\''+esc(m.id)+'\')"><div class="model-option-id">'+esc(m.id)+'</div></div>'
  ).join('');
}
function toggleIterModel(id) {
  const idx = allIterModels.findIndex(m => (m.id||m)===id);
  if (idx>=0) allIterModels.splice(idx,1);
  else allIterModels.push({id,reasoning_effort:null});
  renderSelIterModels();
}
function renderSelIterModels() {
  const el = document.getElementById('sel-iter-models');
  if (!allIterModels.length) { el.innerHTML = '<p style="font-size:12px;color:var(--stone);">No iteration models selected (will reuse main models).</p>'; return; }
  el.innerHTML = allIterModels.map((m,i) => {
    const id = m.id||m;
    return '<div class="sel-model-row"><span class="sel-model-id" title="'+esc(id)+'">'+esc(id)+'</span>'+
      '<button class="rm-btn" onclick="allIterModels.splice('+i+',1);renderSelIterModels()">&#215;</button></div>';
  }).join('');
}

// Judge model search
async function searchJudge(q) {
  document.getElementById('judge-dd').style.display='block';
  const res = await fetch('/api/models?q='+encodeURIComponent(q)+'&limit=20&offset=0');
  const d = await res.json();
  document.getElementById('judge-options').innerHTML = d.models.map(m =>
    '<div class="model-option" onclick="selectJudge(\''+esc(m.id)+'\')"><div class="model-option-id">'+esc(m.id)+'</div></div>'
  ).join('');
}
function showJudgeDD() {
  document.getElementById('judge-dd').style.display='block';
  if (!document.getElementById('judge-options').children.length) searchJudge('');
}
function selectJudge(id) {
  cfg.judge.model = id;
  document.getElementById('judge-search').value = id;
  document.getElementById('judge-sel').textContent = 'Judge: '+id;
  document.getElementById('judge-dd').style.display='none';
  updateSum();
}

// Use mousedown so the close check fires before innerHTML replacement destroys the target element
document.addEventListener('mousedown', e => {
  if (!e.target.closest('#model-search') && !e.target.closest('#model-dd')) { const d=document.getElementById('model-dd'); if(d) d.style.display='none'; }
  if (!e.target.closest('#judge-search') && !e.target.closest('#judge-dd')) { const d=document.getElementById('judge-dd'); if(d) d.style.display='none'; }
  if (!e.target.closest('#iter-model-search') && !e.target.closest('#iter-model-dd')) { const d=document.getElementById('iter-model-dd'); if(d) d.style.display='none'; }
});

// Prompts
function renderPromptList() {
  const el = document.getElementById('prompt-list');
  const cats = ['illustration','logo','icon','data-visualization','abstract','typography','scene'];
  el.innerHTML = cfg.prompts.map((p,i) =>
    '<div class="prompt-row">'+
    '<input type="text" class="prompt-text-input" value="'+esc(p.text||'')+'" placeholder="Describe the SVG..." onchange="cfg.prompts['+i+'].text=this.value">'+
    '<select class="prompt-cat" onchange="cfg.prompts['+i+'].category=this.value">'+cats.map(c=>'<option value="'+c+'"'+(p.category===c?' selected':'')+'>'+c+'</option>').join('')+'</select>'+
    '<button class="rm-btn" onclick="cfg.prompts.splice('+i+',1);renderPromptList()">&#215;</button></div>'
  ).join('');
  updateSum();
}
function addPromptRow() {
  cfg.prompts.push({id:crypto.randomUUID(),text:'',category:'illustration'});
  renderPromptList();
  const rows = document.querySelectorAll('.prompt-row');
  if(rows.length) rows[rows.length-1].querySelector('input').focus();
}
function clearPrompts() { cfg.prompts=[]; renderPromptList(); renderImagePromptList(); renderEditPromptList(); }
async function loadDefaultPrompts() {
  const res = await fetch('/api/default-prompts');
  cfg.prompts = await res.json();
  renderPromptList();
}
async function generatePrompts() {
  const desc = document.getElementById('ai-gen-desc').value.trim();
  const count = parseInt(document.getElementById('ai-gen-count').value)||8;
  if (!desc) { toast('Enter a description','err'); return; }
  const btn = document.getElementById('ai-gen-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span>';
  try {
    const res = await fetch('/api/generate-prompts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({description:desc,count,existing:cfg.prompts})});
    const d = await res.json();
    if(d.error) throw new Error(d.error);
    cfg.prompts = [...cfg.prompts, ...d.prompts];
    renderPromptList(); toast('Added '+d.prompts.length+' prompts');
  } catch(err) { toast('Failed: '+err.message,'err'); }
  finally { btn.disabled=false; btn.textContent='Generate'; }
}

// Image prompts
function renderImagePromptList() {
  const el = document.getElementById('image-prompt-list');
  if (!el) return;
  el.innerHTML = cfg.prompts.map((p,i) => {
    const hasImg = !!p.reference_image;
    return '<div class="prompt-row" style="flex-direction:column;align-items:flex-start;gap:8px;padding:12px;background:var(--mist);border-radius:6px;">'+
      '<div style="display:flex;align-items:center;gap:8px;width:100%;">'+
      '<input type="text" class="prompt-text-input" value="'+esc(p.text||'')+'" placeholder="Optional: describe the image context..." onchange="cfg.prompts['+i+'].text=this.value" style="flex:1;">'+
      '<button class="rm-btn" onclick="cfg.prompts.splice('+i+',1);renderImagePromptList()">&#215;</button></div>'+
      '<div class="img-upload-area '+(hasImg?'has-image':'')+'" onclick="triggerImgUpload('+i+')">'+
      (hasImg ? '<img class="img-thumbnail" src="'+p.reference_image+'" alt="Reference image">' : '<div style="font-size:12px;color:var(--stone);">Click to upload reference image</div>')+
      '</div>'+
      '<input type="file" accept="image/*" style="display:none" id="img-upload-'+i+'" onchange="handleImgUpload(event,'+i+')">'+
      '</div>';
  }).join('');
  updateSum();
}
function triggerImgUpload(i) { document.getElementById('img-upload-'+i).click(); }
function handleImgUpload(e, i) {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => { cfg.prompts[i].reference_image = ev.target.result; renderImagePromptList(); };
  reader.readAsDataURL(file);
}
function addImagePromptRow() {
  cfg.prompts.push({id:crypto.randomUUID(),text:'',category:'illustration'});
  renderImagePromptList();
}

// Edit prompts
function renderEditPromptList() {
  const el = document.getElementById('edit-prompt-list');
  if (!el) return;
  el.innerHTML = cfg.prompts.map((p,i) =>
    '<div style="border:1.5px solid var(--border);border-radius:6px;padding:12px;margin-bottom:8px;">'+
    '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">'+
    '<span style="font-size:11px;color:var(--stone);">Edit Task '+(i+1)+'</span>'+
    '<button class="rm-btn" onclick="cfg.prompts.splice('+i+',1);renderEditPromptList()">&#215;</button></div>'+
    '<div class="field"><label class="label">Edit Instruction</label>'+
    '<input type="text" value="'+esc(p.edit_instruction||p.text||'')+'" placeholder="e.g. Change all circles to squares" onchange="cfg.prompts['+i+'].edit_instruction=this.value;cfg.prompts['+i+'].text=this.value;"></div>'+
    '<div class="field"><label class="label">Source SVG</label>'+
    '<textarea rows="4" placeholder="Paste SVG code here..." onchange="cfg.prompts['+i+'].source_svg=this.value" style="font-size:11px;">'+esc(p.source_svg||'')+'</textarea></div>'+
    '</div>'
  ).join('');
  updateSum();
}
function addEditPromptRow() {
  cfg.prompts.push({id:crypto.randomUUID(),text:'',edit_instruction:'',source_svg:'',category:'icon'});
  renderEditPromptList();
}

function toggleAdv(id,btn) {
  document.getElementById(id).classList.toggle('open');
  btn.classList.toggle('open');
}

// LIVE RUN
function openLiveRun(id) {
  currentRunId=id;
  runStats={genDone:0,genTotal:0,cmpDone:0,cmpTotal:0,errors:0};
  runStart=Date.now();
  document.getElementById('ev-feed').innerHTML='';
  document.getElementById('svg-grid').innerHTML='';
  document.getElementById('svg-count').textContent='0 rendered';
  document.getElementById('st-gen-done').textContent='0';
  document.getElementById('st-cmp-done').textContent='0';
  document.getElementById('st-errors').textContent='0';
  document.getElementById('st-elapsed').textContent='0:00';
  document.getElementById('run-pbar').style.width='0%';
  document.getElementById('btn-view-results').style.display='none';
  document.getElementById('btn-stop').style.display='';
  showPage('run');
  loadRunMeta(id);
  connectSSE(id);
  clearInterval(elapsedTmr);
  elapsedTmr = setInterval(() => { document.getElementById('st-elapsed').textContent=fmt(Date.now()-runStart); }, 1000);
}

async function loadRunMeta(id) {
  const res = await fetch('/api/runs/'+id);
  const run = await res.json();
  document.getElementById('run-title').textContent = run.name;
  document.getElementById('run-status').innerHTML = '<span class="s-'+run.status+'" style="display:flex;align-items:center;"><span class="status-dot"></span>'+run.status+'</span>';
  document.getElementById('btn-export').href='/api/runs/'+id+'/export/json';
  document.getElementById('btn-export').download='pathscore-'+id.slice(0,8)+'.json';
  const N=run.config.models.length, M=run.config.prompts.length, R=run.config.judge?.runs||1;
  runStats.genTotal=N*M;
  runStats.cmpTotal=M*N*(N-1)/2*R;
  document.getElementById('st-gen-total').textContent='of '+runStats.genTotal+' total';
  document.getElementById('st-cmp-total').textContent='of '+runStats.cmpTotal+' total';
  if(run.status==='complete') {
    clearInterval(elapsedTmr);
    document.getElementById('btn-view-results').style.display='';
    document.getElementById('btn-stop').style.display='none';
    if(run.started_at) runStart=run.started_at;
  }
}

function connectSSE(id) {
  if(sseConn) sseConn.close();
  const es = new EventSource('/api/runs/'+id+'/events');
  sseConn = es;
  const h = {
    run_start: d => { addEv('Run started', sm(d.modelIds?.[0]||'')+' +'+((d.modelIds?.length||1)-1)+' more x '+d.promptCount+' prompts ['+esc(d.mode||'standard')+']', '', ''); setStatus('running'); },
    generation_start: d => addEv('Generating', esc(sm(d.modelId)), esc(trunc('"'+d.promptText+'"',50)), 'ev-gen-start'),
    generation_complete: d => { runStats.genDone++; updateStats(); addEv('SVG ready', esc(sm(d.modelId))+' - '+d.timeMs+'ms', esc(trunc('"'+d.promptText+'"',40)), 'ev-gen-ok'); addThumb(d.genId, d.modelId, d.promptText); },
    generation_error: d => { runStats.errors++; updateStats(); addEv('Failed', esc(sm(d.modelId))+': '+esc(trunc(d.error,60)), '', 'ev-gen-err'); },
    comparison_start: d => addEv('Judging', esc(sm(d.modelA))+' vs '+esc(sm(d.modelB)), esc(trunc('"'+d.promptText+'"',40)), 'ev-cmp-start'),
    comparison_complete: d => {
      runStats.cmpDone++; updateStats();
      const wb = d.winner==='A'?'<span class="wb wb-a">A wins</span>':d.winner==='B'?'<span class="wb wb-b">B wins</span>':'<span class="wb wb-tie">tie</span>';
      const sc = d.scoreA!=null?' ('+d.scoreA+'-'+d.scoreB+')':'';
      addEv(esc(sm(d.modelA))+' vs '+esc(sm(d.modelB)), wb+sc, esc(trunc(d.thoughtProcess||'',80)), 'ev-cmp-ok');
    },
    comparison_error: d => { runStats.errors++; updateStats(); addEv('Judge failed', esc(trunc(d.error,80)), '', 'ev-cmp-err'); },
    iteration_start: d => addEv('Iterating', esc(sm(d.modelId)), esc(trunc(d.feedback||'',60)), 'ev-gen-start'),
    iteration_complete: d => { addEv('Iteration ready', esc(sm(d.modelId)), '', 'ev-gen-ok'); },
    iter_comparison_complete: d => { addEv('Iter judged', esc(sm(d.modelA))+' vs '+esc(sm(d.modelB)), d.bothBad?'Both bad':'Winner: '+d.winner, 'ev-cmp-ok'); },
    comparison_pending_human: d => addEv('Pending human', esc(sm(d.modelA))+' vs '+esc(sm(d.modelB)), '', 'ev-cmp-start'),
    phase_start: d => addEv('Phase '+d.phase, d.label, '', ''),
    run_complete: () => { clearInterval(elapsedTmr); setStatus('complete'); addEv('Complete','All done!','',''); document.getElementById('btn-view-results').style.display=''; document.getElementById('btn-stop').style.display='none'; },
    run_error: d => { clearInterval(elapsedTmr); setStatus('error'); addEv('Error', esc(d.error),'','ev-gen-err'); },
    run_stopped: () => { clearInterval(elapsedTmr); setStatus('stopped'); addEv('Stopped','Run was stopped manually','',''); document.getElementById('btn-view-results').style.display=''; document.getElementById('btn-stop').style.display='none'; },
  };
  Object.entries(h).forEach(([t,fn]) => es.addEventListener(t, e => { try { fn(JSON.parse(e.data)); } catch(_){} }));
  es.onerror = () => {};
}

function setStatus(s) {
  document.getElementById('run-status').innerHTML='<span class="s-'+s+'" style="display:flex;align-items:center;"><span class="status-dot"></span>'+s+'</span>';
}
function updateStats() {
  document.getElementById('st-gen-done').textContent=runStats.genDone;
  document.getElementById('st-cmp-done').textContent=runStats.cmpDone;
  document.getElementById('st-errors').textContent=runStats.errors;
  const total=runStats.genTotal+runStats.cmpTotal, done=runStats.genDone+runStats.cmpDone;
  document.getElementById('run-pbar').style.width=total>0?(done/total*100)+'%':'0%';
}

let evCount=0;
function addEv(title, sub, detail, cls) {
  evCount++;
  const feed=document.getElementById('ev-feed');
  const el=document.createElement('div');
  el.className='event-item '+(cls||'');
  el.innerHTML='<div class="ev-header"><span class="ev-title">'+title+'</span><span class="ev-time">'+new Date().toLocaleTimeString()+'</span></div>'+(sub?'<div class="ev-meta">'+sub+'</div>':'')+(detail?'<div style="font-size:11px;color:var(--stone);margin-top:2px;">'+detail+'</div>':'');
  feed.insertBefore(el,feed.firstChild);
  while(feed.children.length>200) feed.removeChild(feed.lastChild);
}

let thumbCount=0;
function addThumb(genId, modelId, promptText) {
  thumbCount++;
  document.getElementById('svg-count').textContent=thumbCount+' rendered';
  const grid=document.getElementById('svg-grid');
  const el=document.createElement('div');
  el.className='svg-thumb';
  const safeId=esc(genId);
  el.setAttribute('onclick','showSVGModal("'+esc(genId)+'","'+esc(modelId)+'","'+esc(promptText)+'")');
  el.innerHTML='<div class="svg-thumb-img"><img src="/api/generations/'+safeId+'/svg" loading="lazy" alt=""></div><div class="svg-thumb-meta"><div class="svg-thumb-model">'+esc(sm(modelId))+'</div><div class="svg-thumb-prompt">'+esc(trunc(promptText,40))+'</div></div>';
  grid.insertBefore(el,grid.firstChild);
}

async function showSVGModal(genId, modelId, promptText) {
  document.getElementById('modal-model').textContent = sm(modelId);
  document.getElementById('modal-prompt').textContent = promptText;
  document.getElementById('modal-img').innerHTML = '<img src="/api/generations/'+esc(genId)+'/svg" style="max-width:100%;max-height:400px;display:block;margin:0 auto;" alt="">';
  document.getElementById('modal-code').style.display='none';
  document.getElementById('modal-dl').href='/api/generations/'+esc(genId)+'/svg';
  document.getElementById('modal-dl').download='pathscore-'+genId.slice(0,8)+'.svg';
  const res = await fetch('/api/generations/'+esc(genId)+'/svg');
  document.getElementById('modal-code').textContent = await res.text();
  document.getElementById('svg-modal').classList.add('open');
}

async function stopRun() {
  await fetch('/api/runs/'+currentRunId+'/stop',{method:'POST'});
  toast('Stop signal sent');
}

// RESULTS
function viewResults(id) {
  currentRunId=id; showPage('results'); loadResults(id);
}
async function loadResults(id) {
  document.getElementById('res-title').textContent='Loading...';
  const res = await fetch('/api/runs/'+id+'/results');
  resultsData = await res.json();
  allCmps = resultsData.comparisons||[];
  document.getElementById('res-title').textContent = resultsData.run.name;
  const mode = resultsData.run.mode || resultsData.run.config?.mode || 'standard';
  document.getElementById('res-sub').textContent = resultsData.models.length+' models · '+resultsData.run.config.prompts.length+' prompts · '+allCmps.filter(c=>c.status==='complete').length+' comparisons · '+mode;
  document.getElementById('export-bar').dataset.runId = id;
  // Mode-specific tabs
  const iterBtn = document.getElementById('tab-iter-btn');
  const agreeBtn = document.getElementById('tab-agree-btn');
  const humanBtn = document.getElementById('tab-human-btn');
  iterBtn.style.display = mode==='feedback_iteration' ? '' : 'none';
  agreeBtn.style.display = mode==='human_eval' ? '' : 'none';
  humanBtn.style.display = mode==='human_eval' ? '' : 'none';
  const jeBtn = document.getElementById('tab-je-btn');
  const jeVoteBtn = document.getElementById('tab-je-vote-btn');
  jeBtn.style.display = mode==='judge_eval' ? '' : 'none';
  jeVoteBtn.style.display = 'none'; // shown after checking pending count
  renderLB(); renderHM(); filterCmps(''); renderOutputs(); populateOutFilters();
  if (mode==='feedback_iteration') renderIterResults();
  if (mode==='human_eval') renderAgreement();
  if (mode==='judge_eval') {
    fetch('/api/runs/'+id+'/judge-eval/results').then(r=>r.json()).then(data => {
      renderJELeaderboard(data);
      jeVoteBtn.style.display = data.pending > 0 ? '' : 'none';
    });
  }
}

function renderLB() {
  const lb=resultsData.leaderboard, maxElo=Math.max(...lb.map(r=>r.elo),1001);
  document.getElementById('lb-body').innerHTML = lb.map((row,i) => {
    const rank=i+1, rc=rank<=3?'r'+rank:'', pct=maxElo>0?(row.elo/maxElo*100):50;
    const wr=row.total>0?((row.wins+row.ties*.5)/row.total*100).toFixed(0)+'%':'--';
    return '<tr><td><span class="rank '+rc+'">'+rank+'</span></td>'+
      '<td style="font-family:var(--font-b);font-size:12px;">'+esc(row.model)+'</td>'+
      '<td><div class="elo-bar-row"><div class="elo-bar"><div class="elo-bar-fill" style="width:'+pct+'%;background:'+(rank===1?'var(--ember)':'var(--ink)')+'"></div></div><div class="elo-num">'+row.elo+'</div></div></td>'+
      '<td style="font-size:12px;color:var(--stone);">'+wr+'</td>'+
      '<td style="font-size:12px;color:var(--stone);"><strong>'+row.wins+'</strong> / '+row.losses+' / '+row.ties+'</td>'+
      '<td style="font-size:12px;color:var(--stone);">'+(row.avgScore??'--')+'</td></tr>';
  }).join('');
}

function renderHM() {
  const models=resultsData.models, hm=resultsData.heatmap;
  if (!models || models.length < 2) {
    document.getElementById('hm-wrap').innerHTML='<p style="color:var(--stone);font-size:13px;">Need at least 2 models for heatmap.</p>';
    return;
  }
  const cols=models.map(m=>'<th title="'+esc(m)+'">'+esc(trunc(sm(m),12))+'</th>').join('');
  const rows=models.map(rm => {
    const cells=models.map(cm => {
      if(rm===cm) return '<td><div class="hm-cell hm-na">N/A</div></td>';
      const v=hm[rm]?.[cm];
      if(v===null||v===undefined) return '<td><div class="hm-cell" style="background:#f9f9f9;color:var(--stone);">--</div></td>';
      const r=Math.round(232*v+76*(1-v)), g=Math.round(77*v+175*(1-v)), b=Math.round(47*v+74*(1-v));
      return '<td><div class="hm-cell" style="background:rgb('+r+','+g+','+b+');color:white;">'+(v*100).toFixed(0)+'%</div></td>';
    }).join('');
    return '<tr><td class="hm-row-lbl" title="'+esc(rm)+'">'+esc(trunc(sm(rm),12))+'</td>'+cells+'</tr>';
  }).join('');
  document.getElementById('hm-wrap').innerHTML='<table class="hm-table"><thead><tr><th></th>'+cols+'</tr></thead><tbody>'+rows+'</tbody></table>';
}

function filterCmps(text) {
  const ft=text.toLowerCase(), wf=document.getElementById('cmp-wf').value;
  window._fCmps = allCmps.filter(c => {
    if(c.status!=='complete') return false;
    if(wf && c.winner!==wf) return false;
    if(ft && !c.model_a_id.toLowerCase().includes(ft) && !c.model_b_id.toLowerCase().includes(ft) && !c.prompt_text.toLowerCase().includes(ft)) return false;
    return true;
  });
  cmpPage=0; renderCmpPage();
}

function renderCmpPage() {
  const filtered=window._fCmps||[], slice=filtered.slice(0,(cmpPage+1)*CMP_PS);
  const mode = resultsData?.run?.mode || 'standard';
  document.getElementById('cmp-grid').innerHTML = slice.map(c => {
    const wb=c.winner==='A'?'<span class="wb wb-a">A wins ('+c.model_a_score+'/10)</span>':c.winner==='B'?'<span class="wb wb-b">B wins ('+c.model_b_score+'/10)</span>':'<span class="wb wb-tie">Tie</span>';
    const safeA=esc(c.generation_a_id), safeB=esc(c.generation_b_id);
    // For image_to_svg mode, find reference image
    let refImg = '';
    if (mode==='image_to_svg') {
      const prompt = resultsData.run.config.prompts.find(p => p.id===c.prompt_id);
      if (prompt?.reference_image) refImg = '<div class="cmp-img-slot"><div class="label">Reference</div><div class="cmp-svg-box"><img src="'+prompt.reference_image+'" alt="Reference"></div></div>';
    }
    return '<div class="cmp-card">'+
      '<div class="cmp-card-hdr"><span class="cmp-prompt">"'+esc(trunc(c.prompt_text,50))+'"</span>'+wb+'</div>'+
      '<div class="cmp-images" style="grid-template-columns:'+(refImg?'1fr 1fr 1fr':'1fr 1fr')+'">'+
      refImg+
      '<div class="cmp-img-slot"><div class="label">Model A '+(c.winner==='A'?'&#127942;':'')+'</div><div class="cmp-svg-box" onclick="showSVGModal(\''+safeA+'\',\''+esc(c.model_a_id)+'\',\''+esc(c.prompt_text)+'\')"><img src="/api/generations/'+safeA+'/svg" loading="lazy" alt=""></div><div style="font-size:10px;color:var(--stone);margin-top:4px;">'+esc(sm(c.model_a_id))+'</div></div>'+
      '<div class="cmp-img-slot"><div class="label">Model B '+(c.winner==='B'?'&#127942;':'')+'</div><div class="cmp-svg-box" onclick="showSVGModal(\''+safeB+'\',\''+esc(c.model_b_id)+'\',\''+esc(c.prompt_text)+'\')"><img src="/api/generations/'+safeB+'/svg" loading="lazy" alt=""></div><div style="font-size:10px;color:var(--stone);margin-top:4px;">'+esc(sm(c.model_b_id))+'</div></div>'+
      '</div>'+(c.thought_process?'<div class="cmp-card-ftr">'+esc(trunc(c.thought_process,120))+'</div>':'')+
      '</div>';
  }).join('');
  const more=document.getElementById('cmp-more');
  if(filtered.length>slice.length) {
    more.innerHTML='<button class="btn btn-outline btn-sm" onclick="cmpPage++;renderCmpPage()">Load more ('+(filtered.length-slice.length)+' remaining)</button>';
  } else {
    more.innerHTML='<span style="font-size:12px;color:var(--stone);">'+filtered.length+' comparison'+(filtered.length!==1?'s':'')+' shown</span>';
  }
}

function renderIterResults() {
  const iterLb = resultsData.iterLeaderboard;
  const iters = resultsData.iterations || [];
  const iterCmps = resultsData.iterationComparisons || [];
  if (!iterLb || !iterLb.length) {
    document.getElementById('iter-lb-wrap').innerHTML='<p style="color:var(--stone);">No iteration data yet.</p>';
    return;
  }
  const maxElo = Math.max(...iterLb.map(r=>r.elo), 1001);
  document.getElementById('iter-lb-wrap').innerHTML =
    '<h3 style="margin-bottom:16px;">Iteration ELO Leaderboard</h3>'+
    '<table class="lb"><thead><tr><th>#</th><th>Model</th><th>Iteration ELO</th><th>Both Bad Count</th></tr></thead><tbody>'+
    iterLb.map((row,i) => {
      const pct = maxElo>0?(row.elo/maxElo*100):50;
      return '<tr><td><span class="rank '+(i<3?'r'+(i+1):'')+'">'+( i+1)+'</span></td>'+
        '<td style="font-family:var(--font-b);font-size:12px;">'+esc(row.model)+'</td>'+
        '<td><div class="elo-bar-row"><div class="elo-bar"><div class="elo-bar-fill" style="width:'+pct+'%"></div></div><div class="elo-num">'+row.elo+'</div></div></td>'+
        '<td style="font-size:12px;color:var(--stone);">'+(row.bothBadCount||0)+'</td></tr>';
    }).join('')+'</tbody></table>';

  // Show iter comparisons
  const iterCmpHtml = iterCmps.slice(0,20).map(ic => {
    const iterA = iters.find(i=>i.id===ic.iter_a_id);
    const iterB = iters.find(i=>i.id===ic.iter_b_id);
    const origGen = resultsData.generations.find(g=>g.id===ic.original_generation_id);
    return '<div class="iter-cmp-card">'+
      '<div class="cmp-card-hdr">'+
      '<span class="cmp-prompt">"'+esc(trunc(ic.prompt_text,50))+'"</span>'+
      (ic.both_bad?'<span class="both-bad-badge">Both bad</span>':'<span class="wb wb-'+(ic.winner==='A'?'a':'b')+'">'+ic.winner+' wins</span>')+
      '</div>'+
      '<div class="iter-cmp-grid">'+
      (origGen?'<div class="iter-cmp-slot"><div class="label">Original</div><div class="cmp-svg-box"><img src="/api/generations/'+esc(origGen.id)+'/svg" loading="lazy" alt=""></div></div>':'<div class="iter-cmp-slot"></div>')+
      (iterA?'<div class="iter-cmp-slot"><div class="label">Iter A: '+esc(sm(iterA.model_id))+'</div><div class="cmp-svg-box"><img src="/api/generations/'+esc(iterA.id)+'/svg" loading="lazy" alt=""></div></div>':'<div class="iter-cmp-slot"></div>')+
      (iterB?'<div class="iter-cmp-slot"><div class="label">Iter B: '+esc(sm(iterB.model_id))+'</div><div class="cmp-svg-box"><img src="/api/generations/'+esc(iterB.id)+'/svg" loading="lazy" alt=""></div></div>':'<div class="iter-cmp-slot"></div>')+
      '</div>'+
      (ic.feedback?'<div class="cmp-card-ftr">'+esc(trunc(ic.feedback,120))+'</div>':'')+
      '</div>';
  }).join('');
  document.getElementById('iter-cmp-grid').innerHTML = iterCmpHtml;
}

async function renderAgreement() {
  const res = await fetch('/api/runs/'+currentRunId+'/judge-agreement');
  const data = await res.json();
  document.getElementById('agree-wrap').innerHTML =
    '<h3 style="margin-bottom:16px;">LLM vs Human Agreement</h3>'+
    '<div class="grid3" style="gap:16px;max-width:600px;">'+
    '<div class="stat-box"><div class="stat-label">Total Judged by Both</div><div class="stat-val">'+(data.total||0)+'</div></div>'+
    '<div class="stat-box"><div class="stat-label">Agreement</div><div class="stat-val" style="color:#4CAF50">'+(data.agree||0)+'</div></div>'+
    '<div class="stat-box"><div class="stat-label">Agreement Rate</div><div class="stat-val">'+(data.agreementRate||'--')+'%</div></div>'+
    '</div>'+
    (data.total===0?'<p style="margin-top:16px;color:var(--stone);font-size:13px;">No comparisons have been judged by both human and LLM yet.</p>':'');
}

function populateOutFilters() {
  const mf=document.getElementById('out-mf'), pf=document.getElementById('out-pf');
  mf.innerHTML='<option value="">All models</option>'+resultsData.models.map(m=>'<option value="'+esc(m)+'">'+esc(sm(m))+'</option>').join('');
  const prompts=[...new Set(resultsData.generations.map(g=>g.prompt_text))];
  pf.innerHTML='<option value="">All prompts</option>'+prompts.map(p=>'<option value="'+esc(p)+'">'+esc(trunc(p,50))+'</option>').join('');
}

function renderOutputs() {
  const mf=document.getElementById('out-mf').value, pf=document.getElementById('out-pf').value;
  const gens=resultsData.generations.filter(g => g.status==='complete' && (!mf||g.model_id===mf) && (!pf||g.prompt_text===pf));
  document.getElementById('out-grid').innerHTML=gens.map(g =>
    '<div class="svg-thumb" onclick="showSVGModal(\''+esc(g.id)+'\',\''+esc(g.model_id)+'\',\''+esc(g.prompt_text)+'\')">'+
    '<div class="svg-thumb-img"><img src="/api/generations/'+esc(g.id)+'/svg" loading="lazy" alt=""></div>'+
    '<div class="svg-thumb-meta"><div class="svg-thumb-model">'+esc(sm(g.model_id))+'</div><div class="svg-thumb-prompt">'+esc(trunc(g.prompt_text,40))+'</div></div></div>'
  ).join('');
}

// Human Judge
async function loadHumanJudge() {
  humanIdx=0;
  const res = await fetch('/api/runs/'+currentRunId+'/pending-human');
  humanPending = await res.json();
  renderHumanJudge();
}

function renderHumanJudge() {
  const total = humanPending.length;
  document.getElementById('human-progress').textContent = humanIdx+' of '+total+' judged';
  if (humanIdx >= total) {
    document.getElementById('human-judge-container').innerHTML = '<div class="empty-state"><h3>All comparisons judged</h3><p>'+total+' comparisons reviewed.</p><button class="btn btn-primary" onclick="showPage(\'results\')">Back to Results</button></div>';
    return;
  }
  const cmp = humanPending[humanIdx];
  document.getElementById('human-judge-container').innerHTML =
    '<div class="human-cmp-card">'+
    '<div class="human-cmp-hdr"><h3>"'+esc(trunc(cmp.prompt_text,80))+'"</h3><div style="font-size:11px;color:var(--stone);margin-top:4px;">Comparison '+(humanIdx+1)+' of '+total+'</div></div>'+
    '<div class="human-cmp-images">'+
    '<div class="human-img-slot"><div class="label">Model A</div><div class="cmp-svg-box" style="max-width:100%;"><img src="/api/generations/'+esc(cmp.generation_a_id)+'/svg" style="width:100%;height:auto;" alt="Model A"></div>'+
    '<div class="score-row"><label>Score A</label><input type="range" id="score-a" min="0" max="10" value="5" step="1"><span id="score-a-v" style="min-width:24px;text-align:right;">5</span></div></div>'+
    '<div class="human-img-slot"><div class="label">Model B</div><div class="cmp-svg-box" style="max-width:100%;"><img src="/api/generations/'+esc(cmp.generation_b_id)+'/svg" style="width:100%;height:auto;" alt="Model B"></div>'+
    '<div class="score-row"><label>Score B</label><input type="range" id="score-b" min="0" max="10" value="5" step="1"><span id="score-b-v" style="min-width:24px;text-align:right;">5</span></div></div>'+
    '</div>'+
    '<div class="human-cmp-footer">'+
    '<div class="field"><label class="label">Feedback (optional)</label><input type="text" id="human-feedback" placeholder="What could be improved?"></div>'+
    '<div class="vote-btns">'+
    '<button class="vote-btn vote-a" onclick="submitHumanVote(\''+esc(cmp.id)+'\',\'A\')">A is Better</button>'+
    '<button class="vote-btn vote-b" onclick="submitHumanVote(\''+esc(cmp.id)+'\',\'B\')">B is Better</button>'+
    '<button class="vote-btn vote-bb" onclick="submitHumanVote(\''+esc(cmp.id)+'\',\'tie\')">Tie / Skip</button>'+
    '</div></div></div>';

  document.getElementById('score-a').oninput = function() { document.getElementById('score-a-v').textContent=this.value; };
  document.getElementById('score-b').oninput = function() { document.getElementById('score-b-v').textContent=this.value; };
}

async function submitHumanVote(cmpId, winner) {
  const scoreA = parseInt(document.getElementById('score-a')?.value)||5;
  const scoreB = parseInt(document.getElementById('score-b')?.value)||5;
  const feedback = document.getElementById('human-feedback')?.value||'';
  await fetch('/api/runs/'+currentRunId+'/human-judge', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({cmp_id:cmpId, winner, score_a:scoreA, score_b:scoreB, feedback})
  });
  humanIdx++;
  renderHumanJudge();
}

// ── Judge Eval ───────────────────────────────────────────────────────────────

let jeTasks = [], jeIndex = 0, jeTotal = 0, jeDone = 0, jeRunId = null;

async function showPage_judgeEval() {
  jeRunId = currentRunId;
  jeIndex = 0;
  await jeLoadNext();
}

async function jeLoadNext() {
  const data = await fetch('/api/runs/' + jeRunId + '/judge-eval/pending').then(r => r.json());
  jeTasks = data.tasks;
  jeTotal = data.total;
  jeDone = data.done;

  document.getElementById('je-progress-fill').style.width = jeTotal > 0 ? ((jeDone / jeTotal) * 100) + '%' : '0%';
  document.getElementById('je-progress-label').textContent = jeDone + ' / ' + jeTotal + ' rated';

  if (jeTasks.length === 0) {
    document.getElementById('je-svgs').style.display = 'none';
    document.getElementById('je-reveal').style.display = 'none';
    document.getElementById('je-done').style.display = 'block';
    document.getElementById('je-prompt').textContent = '';
    jeLoadJudgeELO();
    return;
  }

  document.getElementById('je-svgs').style.display = 'grid';
  document.getElementById('je-done').style.display = 'none';
  document.getElementById('je-reveal').style.display = 'none';
  document.getElementById('je-btn-a').disabled = false;
  document.getElementById('je-btn-b').disabled = false;
  document.getElementById('je-btn-bad').disabled = false;

  const task = jeTasks[0];
  document.getElementById('je-prompt').textContent = 'Prompt: ' + (task.prompt_text || '');
  document.getElementById('je-img-a').src = '/api/generations/' + task.gen_a_id + '/svg';
  document.getElementById('je-img-b').src = '/api/generations/' + task.gen_b_id + '/svg';
}

async function jeVote(winner) {
  if (!jeTasks.length) return;
  const task = jeTasks[0];
  document.getElementById('je-btn-a').disabled = true;
  document.getElementById('je-btn-b').disabled = true;
  document.getElementById('je-btn-bad').disabled = true;

  await fetch('/api/runs/' + jeRunId + '/judge-eval/vote', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ task_id: task.id, winner }),
  });

  // Reveal judge verdicts
  const verdicts = JSON.parse(task.verdicts || '[]');
  const reveal = document.getElementById('je-reveal');
  const rows = verdicts.map(v => {
    const agrees = v.winner === winner || (winner === 'both_bad' && !v.winner);
    const agreeIcon = v.winner ? (agrees ? '✓' : '✗') : '?';
    const agreeClass = v.winner ? (agrees ? 'correct' : 'wrong') : '';
    const judgeShort = (v.judge_model || '').split('/').pop();
    const pick = v.winner ? ('Picked: ' + v.winner + ' (' + (v.score_a ?? '-') + 'v' + (v.score_b ?? '-') + ')') : '(error)';
    return `<div class="je-verdict-row">
      <div class="je-verdict-judge">${judgeShort}</div>
      <div class="je-verdict-pick">${pick}</div>
      <div class="je-verdict-agree ${agreeClass}">${agreeIcon}</div>
      <div class="je-verdict-feedback">${(v.feedback || '').slice(0, 80)}</div>
    </div>`;
  }).join('');
  const humanLabel = winner === 'both_bad' ? 'Both Bad' : 'You chose: SVG ' + winner;
  reveal.innerHTML = `<div class="je-reveal-hdr">${humanLabel} — Judge verdicts:</div>${rows}<button class="je-next-btn" onclick="jeLoadNext()">Next Pair →</button>`;
  reveal.style.display = 'block';
}

async function jeLoadJudgeELO() {
  const data = await fetch('/api/runs/' + currentRunId + '/judge-eval/results').then(r => r.json());
  renderJELeaderboard(data);
}

function renderJELeaderboard(data) {
  const lb = data.leaderboard || [];
  const maxElo = lb.length ? Math.max(...lb.map(r => r.elo), 1001) : 1001;
  const rows = lb.map((r, i) => {
    const bar = Math.round(((r.elo - 900) / (maxElo - 900)) * 100);
    const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : String(i + 1);
    const rate = r.agree_rate != null ? r.agree_rate + '%' : '--';
    return `<tr>
      <td>${medal}</td>
      <td>${r.judge}</td>
      <td><div style="display:flex;align-items:center;gap:8px"><div style="flex:1;height:8px;background:var(--border);border-radius:4px;"><div style="width:${bar}%;height:100%;background:var(--ember);border-radius:4px;"></div></div><strong>${r.elo}</strong></div></td>
      <td>${rate}</td>
      <td>${r.agree}/${r.total}</td>
    </tr>`;
  }).join('');
  const pending = data.pending > 0 ? `<p style="color:var(--stone);font-size:12px;margin-bottom:16px;">${data.pending} pair(s) still pending human votes — ELO updates as you vote.</p>` : '';
  document.getElementById('je-lb-wrap').innerHTML = `
    ${pending}
    <table class="lb"><thead><tr><th>#</th><th>Judge Model</th><th>ELO Score</th><th>Agree Rate</th><th>Agree/Total</th></tr></thead>
    <tbody>${rows}</tbody></table>
    <p style="font-size:11px;color:var(--stone);margin-top:16px;">ELO: judges that agree with human choices beat those that disagree. Starting ELO 1000, K=32.</p>`;
  if (data.pending > 0) {
    document.getElementById('tab-je-vote-btn').style.display = '';
  }
}

// Keyboard shortcuts for judge eval voting
document.addEventListener('keydown', function(e) {
  if (document.getElementById('page-judge-eval').style.display === 'none') return;
  if (document.getElementById('je-btn-a').disabled) return;
  if (e.key === '1' || e.key === 'ArrowLeft') jeVote('A');
  else if (e.key === '2' || e.key === 'ArrowRight') jeVote('B');
  else if (e.key === '3' || e.key === 'ArrowDown') jeVote('both_bad');
});

// Export
function exportJSON() { window.open('/api/runs/'+(document.getElementById('export-bar').dataset.runId||currentRunId)+'/export/json','_blank'); }
function exportHTML() {
  if(!resultsData) return;
  const lb=resultsData.leaderboard.map((row,i)=>'<tr><td>'+(i+1)+'</td><td>'+row.model+'</td><td>'+row.elo+'</td><td>'+(row.total>0?((row.wins+row.ties*.5)/row.total*100).toFixed(0)+'%':'--')+'</td><td>'+row.wins+'/'+row.losses+'/'+row.ties+'</td><td>'+(row.avgScore??'--')+'</td></tr>').join('');
  const models=resultsData.models, hm=resultsData.heatmap;
  const hmCols=models.map(m=>'<th>'+sm(m)+'</th>').join('');
  const hmRows=models.map(rm=>'<tr><th>'+sm(rm)+'</th>'+models.map(cm=>{if(rm===cm) return '<td style="background:#f5f5f5;">N/A</td>';const v=hm[rm]?.[cm];if(v==null) return '<td>--</td>';const bg=v>.5?'rgba(232,77,47,'+v+')':'rgba(76,175,74,'+(1-v)+')';return '<td style="background:'+bg+';color:white;">'+(v*100).toFixed(0)+'%</td>';}).join('')+'</tr>').join('');
  const html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>PathScore Results - '+resultsData.run.name+'</title>'+
    '<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">'+
    '<style>body{font-family:"IBM Plex Mono",monospace;background:#fff;color:#0a0a0a;padding:48px;max-width:960px;margin:0 auto}h1{font-family:"Outfit",sans-serif;font-weight:800;font-size:32px}h2{font-family:"Outfit",sans-serif;font-weight:700;font-size:20px;margin:40px 0 16px}table{width:100%;border-collapse:collapse}th{text-align:left;font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:#999;padding:8px 12px;border-bottom:2px solid #e8e8e8}td{padding:12px;border-bottom:1px solid #e8e8e8;font-size:13px}
/* ── Extension System ─────────────────────────────────────────── */
.ext-hook-badge{display:inline-block;font-size:10px;font-weight:500;letter-spacing:.06em;text-transform:uppercase;padding:2px 8px;border-radius:10px;}
.badge-provider{background:#d4edda;color:#155724;}
.badge-judge{background:#cce5ff;color:#004085;}
.badge-mode{background:#fff3cd;color:#856404;}
.badge-results{background:#f8d7da;color:#721c24;}
.toggle-switch{position:relative;width:36px;height:20px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:background .2s;}
.toggle-slider:before{content:'';position:absolute;width:14px;height:14px;left:3px;bottom:3px;background:white;border-radius:50%;transition:transform .2s;}
.toggle-switch input:checked + .toggle-slider{background:var(--ember);}
.toggle-switch input:checked + .toggle-slider:before{transform:translateX(16px);}
.ext-card{border:1.5px solid var(--border);border-radius:6px;padding:16px 20px;display:flex;align-items:flex-start;gap:16px;transition:border-color .15s;}
.ext-card:hover{border-color:var(--stone);}
.ext-card-body{flex:1;min-width:0;}
.ext-card-name{font-family:var(--font-h);font-weight:600;font-size:14px;margin-bottom:4px;}
.ext-card-desc{font-size:12px;color:var(--stone);margin-bottom:8px;line-height:1.5;}
.ext-card-actions{display:flex;align-items:center;gap:10px;margin-top:8px;}
.ext-grid{display:flex;flex-direction:column;gap:10px;}
.ai-chat-wrap{display:flex;flex-direction:column;height:480px;border:1.5px solid var(--border);border-radius:6px;overflow:hidden;}
.ai-chat-header{padding:12px 16px;border-bottom:1.5px solid var(--border);display:flex;align-items:center;gap:12px;background:var(--mist);}
.ai-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.ai-msg{max-width:80%;padding:10px 14px;border-radius:8px;font-size:13px;line-height:1.6;white-space:pre-wrap;}
.ai-msg-user{background:var(--ink);color:white;align-self:flex-end;border-radius:8px 8px 2px 8px;}
.ai-msg-assistant{background:var(--mist);color:var(--ink);align-self:flex-start;border-radius:8px 8px 8px 2px;}
.ai-msg pre{background:#0a0a0a;color:#e8e8e8;border-radius:4px;padding:12px;font-family:var(--font-b);font-size:12px;margin:8px 0;overflow-x:auto;white-space:pre;}
.ai-msg .use-code-btn{font-size:11px;background:var(--ember);color:white;border:none;border-radius:3px;padding:4px 10px;cursor:pointer;margin-top:4px;}
.ai-chat-footer{padding:12px;border-top:1.5px solid var(--border);display:flex;gap:8px;}
.ai-chat-footer textarea{flex:1;font-family:var(--font-b);font-size:13px;padding:8px 12px;border:1.5px solid var(--border);border-radius:4px;resize:none;height:40px;outline:none;}
.ai-chat-footer textarea:focus{border-color:var(--ink);}
.ext-code-editor{width:100%;font-family:var(--font-b);font-size:12px;padding:12px;border:1.5px solid var(--border);border-radius:4px;background:#0a0a0a;color:#e8e8e8;height:380px;resize:vertical;outline:none;line-height:1.6;}
.ext-code-editor:focus{border-color:var(--stone);}
.syntax-result{font-size:12px;padding:6px 10px;border-radius:3px;margin-top:6px;display:none;}
.syntax-ok{background:#d4edda;color:#155724;display:block;}
.syntax-err{background:#f8d7da;color:#721c24;display:block;}

</style></head>'+
    '<body><h1>'+resultsData.run.name+'</h1><p style="color:#999;margin-bottom:48px">'+models.length+' models · '+resultsData.run.config.prompts.length+' prompts · '+new Date(resultsData.run.created_at).toLocaleDateString()+'</p>'+
    '<h2>ELO Leaderboard</h2><table><thead><tr><th>#</th><th>Model</th><th>ELO</th><th>Win Rate</th><th>W/L/T</th><th>Avg Score</th></tr></thead><tbody>'+lb+'</tbody></table>'+
    '<h2>Win Rate Heatmap</h2><table style="width:auto"><thead><tr><th></th>'+hmCols+'</tr></thead><tbody>'+hmRows+'</tbody></table>'+
    '<p style="font-size:11px;color:#999;margin-top:64px">Generated by PathScore on '+new Date().toLocaleString()+'</p></body></html>';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download='pathscore-'+resultsData.run.id.slice(0,8)+'.html';
  a.click();
}

// Import
async function importResults(e) {
  const file=e.target.files[0]; if(!file) return;
  try {
    const data=JSON.parse(await file.text());
    const res=await fetch('/api/runs/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const r=await res.json();
    if(r.error) throw new Error(r.error);
    toast('Imported successfully'); loadRuns();
  } catch(err) { toast('Import failed: '+err.message,'err'); }
}

// Tabs
function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

// Init
loadLanding();

// ── Extension System JS ──────────────────────────────────────────────────────

let extEditingId = null;
let aiConversation = [];

function hookBadge(type) {
  const colors = { provider:'badge-provider', judge:'badge-judge', mode:'badge-mode', results:'badge-results' };
  return `<span class="ext-hook-badge ${colors[type]||''}">${type}</span>`;
}

async function loadExtensions() {
  try {
    const exts = await fetch('/api/extensions').then(r => r.json());
    const grid = document.getElementById('ext-library');
    if (!exts.length) { grid.innerHTML = '<div class="stone" style="font-size:13px;">No extensions yet.</div>'; return; }
    grid.innerHTML = exts.map(e => `
      <div class="ext-card" id="extcard-${e.id}">
        <label class="toggle-switch" title="${e.enabled ? 'Enabled' : 'Disabled'}">
          <input type="checkbox" ${e.enabled ? 'checked' : ''} onchange="toggleExt('${e.id}', this)">
          <span class="toggle-slider"></span>
        </label>
        <div class="ext-card-body">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
            <span class="ext-card-name">${e.name}</span>
            ${hookBadge(e.hook_type)}
            ${e.is_builtin ? '<span style="font-size:10px;color:var(--stone);">built-in</span>' : ''}
          </div>
          <div class="ext-card-desc">${e.description}</div>
          ${e.mode_id ? `<div style="font-size:11px;color:var(--stone);">mode_id: ${e.mode_id}</div>` : ''}
          <div class="ext-card-actions">
            <button class="btn btn-outline btn-sm" onclick="openExtModal('${e.id}')">Edit</button>
            ${!e.is_builtin ? `<button class="btn btn-ghost btn-sm" onclick="deleteExt('${e.id}')" style="color:var(--ember);">Delete</button>` : ''}
          </div>
        </div>
      </div>`).join('');
  } catch(e) { console.error(e); }
}

async function toggleExt(id, checkbox) {
  try {
    const r = await fetch('/api/extensions/' + id + '/toggle', { method: 'POST' }).then(r => r.json());
    checkbox.checked = !!r.enabled;
    renderModeCards();
  } catch(e) { checkbox.checked = !checkbox.checked; }
}

async function deleteExt(id) {
  if (!confirm('Delete this extension?')) return;
  await fetch('/api/extensions/' + id, { method: 'DELETE' });
  loadExtensions();
  renderModeCards();
}

function openExtModal(id) {
  extEditingId = id;
  const modal = document.getElementById('ext-modal');
  document.getElementById('ext-modal-title').textContent = id ? 'Edit Extension' : 'New Extension';
  document.getElementById('ext-name').value = '';
  document.getElementById('ext-desc').value = '';
  document.getElementById('ext-hook-type').value = 'judge';
  document.getElementById('ext-mode-id').value = '';
  document.getElementById('ext-mode-label').value = '';
  document.getElementById('ext-mode-icon').value = '';
  document.getElementById('ext-mode-desc').value = '';
  document.getElementById('ext-fn-body').value = '';
  document.getElementById('syntax-result').className = 'syntax-result';
  document.getElementById('syntax-result').textContent = '';
  toggleModeFields();

  if (id) {
    fetch('/api/extensions/' + id).then(r => r.json()).then(e => {
      document.getElementById('ext-name').value = e.name || '';
      document.getElementById('ext-desc').value = e.description || '';
      document.getElementById('ext-hook-type').value = e.hook_type || 'judge';
      document.getElementById('ext-mode-id').value = e.mode_id || '';
      document.getElementById('ext-mode-label').value = e.mode_label || '';
      document.getElementById('ext-mode-icon').value = e.mode_icon || '';
      document.getElementById('ext-mode-desc').value = e.mode_desc || '';
      document.getElementById('ext-fn-body').value = e.fn_body || '';
      toggleModeFields();
    });
  }
  modal.classList.add('open');
}

function closeExtModal() {
  document.getElementById('ext-modal').classList.remove('open');
}

function toggleModeFields() {
  const isMode = document.getElementById('ext-hook-type').value === 'mode';
  document.getElementById('mode-fields').style.display = isMode ? 'block' : 'none';
}

function testSyntax() {
  const body = document.getElementById('ext-fn-body').value;
  const el = document.getElementById('syntax-result');
  try {
    new Function('helpers', body);
    el.textContent = '✓ Syntax OK';
    el.className = 'syntax-result syntax-ok';
  } catch(e) {
    el.textContent = '✗ ' + e.message;
    el.className = 'syntax-result syntax-err';
  }
}

async function saveExt() {
  const body = {
    name: document.getElementById('ext-name').value.trim(),
    description: document.getElementById('ext-desc').value.trim(),
    hook_type: document.getElementById('ext-hook-type').value,
    mode_id: document.getElementById('ext-mode-id').value.trim() || null,
    mode_label: document.getElementById('ext-mode-label').value.trim() || null,
    mode_icon: document.getElementById('ext-mode-icon').value.trim() || null,
    mode_desc: document.getElementById('ext-mode-desc').value.trim() || null,
    fn_body: document.getElementById('ext-fn-body').value,
  };
  if (!body.name || !body.fn_body) { alert('Name and fn_body required'); return; }

  const url = extEditingId ? '/api/extensions/' + extEditingId : '/api/extensions';
  const method = extEditingId ? 'PUT' : 'POST';
  await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  closeExtModal();
  loadExtensions();
  renderModeCards();
}

// AI assistant chat
async function sendAiChat() {
  const input = document.getElementById('ai-chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';

  const hookType = document.getElementById('ai-hook-type').value;
  const msgs = document.getElementById('ai-chat-messages');

  // Add user message
  const userEl = document.createElement('div');
  userEl.className = 'ai-msg ai-msg-user';
  userEl.textContent = msg;
  msgs.appendChild(userEl);
  msgs.scrollTop = msgs.scrollHeight;

  // Add thinking indicator
  const thinkEl = document.createElement('div');
  thinkEl.className = 'ai-msg ai-msg-assistant';
  thinkEl.textContent = '…';
  msgs.appendChild(thinkEl);

  try {
    const r = await fetch('/api/extensions/ai-assist', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: msg, hook_type: hookType, conversation: aiConversation }),
    }).then(r => r.json());

    aiConversation.push({ role: 'user', content: msg });
    aiConversation.push({ role: 'assistant', content: r.reply });

    // Render reply with code highlighting
    thinkEl.innerHTML = renderAiReply(r.reply, hookType);
  } catch(e) {
    thinkEl.textContent = 'Error: ' + e.message;
  }
  msgs.scrollTop = msgs.scrollHeight;
}

function renderAiReply(text, hookType) {
  // Split on code blocks
  const parts = text.split(/(```[\s\S]*?```)/g);
  let html = '';
  let hasCode = false;
  let lastCode = '';
  for (const part of parts) {
    if (part.startsWith('```')) {
      const code = part.replace(/^```\w*
?/, '').replace(/```$/, '');
      hasCode = true;
      lastCode = code;
      html += `<pre>${escHtml(code)}</pre>`;
    } else {
      html += escHtml(part);
    }
  }
  if (hasCode) {
    html += `<br><button class="use-code-btn" onclick="useAiCode(this)" data-code="${encodeURIComponent(lastCode)}" data-hook="${hookType}">Use this code</button>`;
  }
  return html;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function useAiCode(btn) {
  const code = decodeURIComponent(btn.dataset.code);
  const hookType = btn.dataset.hook;
  openExtModal(null);
  document.getElementById('ext-hook-type').value = hookType;
  document.getElementById('ext-fn-body').value = code;
  toggleModeFields();
}

function clearAiChat() {
  aiConversation = [];
  document.getElementById('ai-chat-messages').innerHTML = '<div class="ai-msg ai-msg-assistant">Chat cleared. How can I help you build an extension?</div>';
}

// Dynamic mode cards
const BUILTIN_MODES = [
  { id: 'standard', icon: '▶', label: 'Standard', desc: 'Generate SVGs from prompts, pairwise judge with VLM. Classic ELO ranking.' },
  { id: 'feedback_iteration', icon: '↻', label: 'Feedback Iteration', desc: 'Standard run + models improve SVGs based on judge feedback. Measures learning ability.' },
  { id: 'image_to_svg', icon: '🖼', label: 'Image to SVG', desc: 'Provide a target image — models reproduce it as SVG. Tests accuracy and fidelity.' },
  { id: 'svg_editing', icon: '✎', label: 'SVG Editing', desc: 'Give models an existing SVG plus an edit instruction. Tests instruction following.' },
  { id: 'human_eval', icon: '👁', label: 'Human Evaluation', desc: 'You judge comparisons alongside LLMs. Track human vs AI agreement.' },
];

async function renderModeCards() {
  const container = document.getElementById('mode-cards-container');
  if (!container) return;

  let extModes = [];
  try { extModes = await fetch('/api/extensions/modes').then(r => r.json()); } catch(e) {}
  const enabledExtModes = extModes.filter(e => e.enabled);

  const all = [
    ...BUILTIN_MODES,
    ...enabledExtModes.map(e => ({ id: e.mode_id, icon: e.mode_icon || '🔧', label: e.mode_label || e.name, desc: e.mode_desc || e.description, isExt: true }))
  ];

  container.innerHTML = all.map(m => `
    <div class="mode-card ${cfg.mode===m.id ? 'selected' : ''}" id="mode-${m.id}" onclick="selectMode('${m.id}')">
      <div class="mode-card-icon">${m.icon}</div>
      <div class="mode-card-title">${m.label}${m.isExt ? ' <span style=\"font-size:10px;color:var(--stone);\">ext</span>' : ''}</div>
      <div class="mode-card-desc">${m.desc}</div>
    </div>`).join('');
}

  // ===== FLOW BUILDER =====
  let flowEditor = null;
  let flowEditorReady = false;
  let flowChatHistory = [];
  let activePreset = null;

  // ---- Node HTML Templates ----
  const FLOW_MODEL_TPL = `
    <div class="ps-node-header"><span class="ps-node-dot dot-model"></span>MODEL</div>
    <div class="ps-node-body">
      <div><div class="ps-field-label">Model ID</div>
        <input type="text" class="ps-input" df-model-id placeholder="provider/model-name"></div>
      <div><div class="ps-field-label">Reasoning Effort</div>
        <select class="ps-input ps-select" df-reasoning>
          <option value="">none</option>
          <option value="low">low</option>
          <option value="high">high</option>
        </select></div>
    </div>`;

  const FLOW_PROMPT_TPL = `
    <div class="ps-node-header"><span class="ps-node-dot dot-prompt"></span>PROMPT PACK</div>
    <div class="ps-node-body">
      <div class="ps-field-label">Prompts</div>
      <div class="prompt-rows" id="flow-pr-NODEID"></div>
      <button class="add-prompt-btn" onclick="flowAddPromptRow(this)">+ Add prompt</button>
      <input type="hidden" df-prompts value="[]">
    </div>`;

  const FLOW_JUDGE_TPL = `
    <div class="ps-node-header"><span class="ps-node-dot dot-judge"></span>JUDGE</div>
    <div class="ps-node-body">
      <div><div class="ps-field-label">Judge Model</div>
        <input type="text" class="ps-input" df-judge-model placeholder="google/gemini-3-flash-preview"></div>
      <div><div class="ps-field-label">Runs per pair (1–5)</div>
        <input type="number" class="ps-input" df-judge-runs min="1" max="5" value="2"></div>
    </div>`;

  const FLOW_RUNNER_TPL = `
    <div class="ps-node-header"><span class="ps-node-dot dot-runner"></span>RUNNER</div>
    <div class="ps-node-body">
      <div><div class="ps-field-label">Benchmark Name</div>
        <input type="text" class="ps-input" df-bench-name placeholder="My Benchmark"></div>
      <div><div class="ps-field-label">Mode</div>
        <select class="ps-input ps-select" df-mode>
          <option value="standard">Standard</option>
          <option value="feedback_iteration">Feedback Loop</option>
          <option value="human_eval">Human Eval</option>
          <option value="image_to_svg">Image to SVG</option>
        </select></div>
      <div><div class="ps-field-label">Temperature <span class="temp-display" id="flow-temp-val">0.7</span></div>
        <input type="range" class="ps-input" df-temp min="0" max="1" step="0.1" value="0.7"
          oninput="document.getElementById('flow-temp-val').textContent=this.value"></div>
    </div>`;

  const FLOW_RESULTS_TPL = `
    <div class="ps-node-header"><span class="ps-node-dot dot-results"></span>RESULTS</div>
    <div class="ps-node-body">
      <div class="flow-estimate" id="flow-estimate">Connect nodes and click Launch to start.</div>
      <button class="flow-node-launch-btn" onclick="launchFlow()">▶ Launch Benchmark</button>
    </div>`;

  // ---- Init ----
  function initFlowEditor() {
    if (flowEditorReady) return;
    const el = document.getElementById('drawflow');
    flowEditor = new Drawflow(el);
    flowEditor.reroute = true;
    flowEditor.reroute_fix_curvature = true;
    flowEditor.zoom_max = 2.5;
    flowEditor.zoom_min = 0.2;
    flowEditor.start();
    flowEditorReady = true;
    // Close add menu on canvas click
    el.addEventListener('click', function(e) {
      if (!e.target.closest('.flow-add-menu')) {
        document.getElementById('flow-add-dd').classList.remove('open');
      }
    });
    loadFlowPreset('quick_showdown');
  }

  function toggleFlowAddMenu(e) {
    if (e) e.stopPropagation();
    document.getElementById('flow-add-dd').classList.toggle('open');
  }

  // ---- Add Node ----
  function addFlowNode(type, x, y, data) {
    data = data || {};
    const cfgs = {
      model:   { inputs:0, outputs:1, cls:'ps-node-model',   tpl: FLOW_MODEL_TPL },
      prompt:  { inputs:0, outputs:1, cls:'ps-node-prompt',  tpl: FLOW_PROMPT_TPL },
      judge:   { inputs:0, outputs:1, cls:'ps-node-judge',   tpl: FLOW_JUDGE_TPL },
      runner:  { inputs:3, outputs:1, cls:'ps-node-runner',  tpl: FLOW_RUNNER_TPL },
      results: { inputs:1, outputs:0, cls:'ps-node-results', tpl: FLOW_RESULTS_TPL },
    };
    const c = cfgs[type];
    if (!c) return null;
    const id = flowEditor.addNode(type, c.inputs, c.outputs, x, y, c.cls, data, c.tpl);
    // After DOM insertion, populate prompt rows if any
    if (type === 'prompt' && data.prompts) {
      let prompts;
      try { prompts = typeof data.prompts === 'string' ? JSON.parse(data.prompts) : data.prompts; } catch(e) { prompts = []; }
      setTimeout(() => {
        const rowsEl = document.getElementById('flow-pr-' + id) ||
          document.querySelector('.drawflow-node[id="node-' + id + '"] .prompt-rows');
        if (rowsEl) { rowsEl.innerHTML = ''; prompts.forEach(t => flowAddPromptRowText(rowsEl, t)); }
        flowSyncPrompts(id);
      }, 50);
    }
    return id;
  }

  // ---- Prompt row management ----
  function flowAddPromptRow(btn) {
    const rows = btn.previousElementSibling;
    if (rows && rows.classList.contains('prompt-rows')) {
      flowAddPromptRowText(rows, '');
      // Find node id and sync
      const nodeEl = btn.closest('.drawflow-node');
      if (nodeEl) { const nid = parseInt(nodeEl.id.replace('node-','')); flowSyncPrompts(nid); }
    }
  }
  function flowAddPromptRowText(rowsEl, text) {
    const row = document.createElement('div');
    row.className = 'prompt-row';
    const inp = document.createElement('input');
    inp.placeholder = 'prompt text...';
    inp.value = text;
    inp.addEventListener('input', function() {
      const nodeEl = rowsEl.closest('.drawflow-node');
      if (nodeEl) { const nid = parseInt(nodeEl.id.replace('node-','')); flowSyncPrompts(nid); }
    });
    const del = document.createElement('button');
    del.className = 'prompt-del-btn';
    del.textContent = '×';
    del.onclick = function() {
      row.remove();
      const nodeEl = rowsEl.closest('.drawflow-node');
      if (nodeEl) { const nid = parseInt(nodeEl.id.replace('node-','')); flowSyncPrompts(nid); }
    };
    row.appendChild(inp);
    row.appendChild(del);
    rowsEl.appendChild(row);
  }
  function flowSyncPrompts(nodeId) {
    const nodeEl = document.getElementById('node-' + nodeId);
    if (!nodeEl) return;
    const rows = nodeEl.querySelectorAll('.prompt-row input');
    const texts = Array.from(rows).map(i => i.value.trim()).filter(Boolean);
    const hidden = nodeEl.querySelector('input[df-prompts]');
    if (hidden) hidden.value = JSON.stringify(texts);
    if (flowEditor && flowEditor.drawflow.drawflow.Home.data[nodeId]) {
      flowEditor.drawflow.drawflow.Home.data[nodeId].data.prompts = JSON.stringify(texts);
    }
  }

  // ---- Clear ----
  function clearFlow() {
    if (flowEditor) { flowEditor.clear(); activePreset = null; }
    document.querySelectorAll('.flow-preset-btn').forEach(b => b.classList.remove('active'));
  }

  // ---- Presets ----
  const FLOW_PRESETS = {
    quick_showdown: {
      nodes: [
        { key:'m1', type:'model',  x:60,  y:60,  data:{'model-id':'anthropic/claude-sonnet-4-5', reasoning:'high'} },
        { key:'m2', type:'model',  x:60,  y:200, data:{'model-id':'google/gemini-flash-1.5', reasoning:''} },
        { key:'p1', type:'prompt', x:60,  y:360, data:{prompts:JSON.stringify(['a minimalist logo for a tech startup','a pelican riding a bicycle','an abstract data visualization'])} },
        { key:'j1', type:'judge',  x:60,  y:560, data:{'judge-model':'google/gemini-3-flash-preview','judge-runs':'1'} },
        { key:'r1', type:'runner', x:440, y:280, data:{'bench-name':'Quick Showdown', mode:'standard', temp:'0.7'} },
        { key:'re', type:'results',x:780, y:280, data:{} },
      ],
      connections: [
        ['m1','1','r1','1'],['m2','1','r1','1'],['p1','1','r1','2'],['j1','1','r1','3'],['r1','1','re','1']
      ]
    },
    full_standard: {
      nodes: [
        { key:'m1', type:'model', x:60, y:40,  data:{'model-id':'minimax/minimax-m2.5', reasoning:'high'} },
        { key:'m2', type:'model', x:60, y:130, data:{'model-id':'z-ai/glm-5', reasoning:'high'} },
        { key:'m3', type:'model', x:60, y:220, data:{'model-id':'moonshotai/kimi-k2.5', reasoning:'high'} },
        { key:'m4', type:'model', x:60, y:310, data:{'model-id':'qwen/qwen3.5-27b', reasoning:'high'} },
        { key:'m5', type:'model', x:60, y:400, data:{'model-id':'qwen/qwen3.5-122b-a10b', reasoning:'high'} },
        { key:'m6', type:'model', x:60, y:490, data:{'model-id':'qwen/qwen3.5-35b-a3b', reasoning:'high'} },
        { key:'m7', type:'model', x:60, y:580, data:{'model-id':'stepfun/step-3.5-flash', reasoning:'high'} },
        { key:'m8', type:'model', x:60, y:670, data:{'model-id':'liquid/lfm-2-24b-a2b', reasoning:'high'} },
        { key:'p1', type:'prompt', x:310, y:40, data:{prompts:JSON.stringify([
            'a pelican riding a bicycle',
            'An aesthetic data visualization line graph with gold on charcoal',
            'A modern S logo mark with purple and cyan gradient',
            'A glassmorphism weather cloud icon with sapphire raindrops',
            'Isometric infinite staircase in cyberpunk colors',
            'An aesthetic donut chart for lifestyle balance',
            'A vintage hot air balloon illustration in retro sunset colors',
            'VISTA typography logo in navy and silver'
          ])} },
        { key:'j1', type:'judge', x:310, y:500, data:{'judge-model':'google/gemini-3-flash-preview','judge-runs':'2'} },
        { key:'r1', type:'runner', x:580, y:300, data:{'bench-name':'Full Standard Run', mode:'standard', temp:'0.7'} },
        { key:'re', type:'results', x:860, y:300, data:{} },
      ],
      connections: [
        ['m1','1','r1','1'],['m2','1','r1','1'],['m3','1','r1','1'],['m4','1','r1','1'],
        ['m5','1','r1','1'],['m6','1','r1','1'],['m7','1','r1','1'],['m8','1','r1','1'],
        ['p1','1','r1','2'],['j1','1','r1','3'],['r1','1','re','1']
      ]
    },
    feedback_loop: {
      nodes: [
        { key:'m1', type:'model',  x:60, y:80,  data:{'model-id':'anthropic/claude-sonnet-4-5', reasoning:'high'} },
        { key:'m2', type:'model',  x:60, y:220, data:{'model-id':'google/gemini-flash-1.5', reasoning:''} },
        { key:'m3', type:'model',  x:60, y:360, data:{'model-id':'openai/gpt-4o-mini', reasoning:''} },
        { key:'p1', type:'prompt', x:60, y:510, data:{prompts:JSON.stringify(['a clean minimalist icon for a calendar app','a logo for a coffee brand called Morning Ritual','a flat illustration of a city skyline at sunset','a geometric pattern using triangles and hexagons','an infographic showing steps in a process'])} },
        { key:'j1', type:'judge',  x:60, y:710, data:{'judge-model':'google/gemini-3-flash-preview','judge-runs':'2'} },
        { key:'r1', type:'runner', x:440, y:340, data:{'bench-name':'Feedback Loop', mode:'feedback_iteration', temp:'0.7'} },
        { key:'re', type:'results',x:790, y:340, data:{} },
      ],
      connections: [
        ['m1','1','r1','1'],['m2','1','r1','1'],['m3','1','r1','1'],
        ['p1','1','r1','2'],['j1','1','r1','3'],['r1','1','re','1']
      ]
    },
    human_eval: {
      nodes: [
        { key:'m1', type:'model',  x:60, y:80,  data:{'model-id':'anthropic/claude-opus-4-6', reasoning:'high'} },
        { key:'m2', type:'model',  x:60, y:220, data:{'model-id':'google/gemini-flash-1.5', reasoning:''} },
        { key:'m3', type:'model',  x:60, y:360, data:{'model-id':'openai/gpt-4o', reasoning:''} },
        { key:'m4', type:'model',  x:60, y:500, data:{'model-id':'meta-llama/llama-3.3-70b-instruct', reasoning:''} },
        { key:'p1', type:'prompt', x:60, y:660, data:{prompts:JSON.stringify(['a detailed illustration of a fantasy map','a stylized portrait of a robot in watercolor style','an art nouveau poster design','a technical diagram showing API flow','a retro 80s synthwave landscape'])} },
        { key:'j1', type:'judge',  x:60, y:860, data:{'judge-model':'google/gemini-3-flash-preview','judge-runs':'1'} },
        { key:'r1', type:'runner', x:440, y:420, data:{'bench-name':'Human Evaluation', mode:'human_eval', temp:'0.8'} },
        { key:'re', type:'results',x:800, y:420, data:{} },
      ],
      connections: [
        ['m1','1','r1','1'],['m2','1','r1','1'],['m3','1','r1','1'],['m4','1','r1','1'],
        ['p1','1','r1','2'],['j1','1','r1','3'],['r1','1','re','1']
      ]
    },
    multi_judge: {
      nodes: [
        { key:'m1', type:'model',  x:60, y:80,  data:{'model-id':'anthropic/claude-sonnet-4-5', reasoning:'high'} },
        { key:'m2', type:'model',  x:60, y:220, data:{'model-id':'google/gemini-flash-1.5', reasoning:''} },
        { key:'m3', type:'model',  x:60, y:360, data:{'model-id':'openai/gpt-4o-mini', reasoning:''} },
        { key:'p1', type:'prompt', x:60, y:510, data:{prompts:JSON.stringify(['a logo for a fintech startup','an abstract sculpture in isometric view','a minimal icon set for a weather app'])} },
        { key:'j1', type:'judge',  x:60, y:670, data:{'judge-model':'google/gemini-3-flash-preview','judge-runs':'3'} },
        { key:'r1', type:'runner', x:430, y:310, data:{'bench-name':'Multi-Judge Consensus', mode:'standard', temp:'0.7'} },
        { key:'re', type:'results',x:780, y:310, data:{} },
      ],
      connections: [
        ['m1','1','r1','1'],['m2','1','r1','1'],['m3','1','r1','1'],
        ['p1','1','r1','2'],['j1','1','r1','3'],['r1','1','re','1']
      ]
    }
  };

  function loadFlowPreset(name) {
    if (!flowEditor) return;
    flowEditor.clear();
    activePreset = name;
    document.querySelectorAll('.flow-preset-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.querySelector('.flow-preset-btn[onclick*="' + name + '"]');
    if (activeBtn) activeBtn.classList.add('active');

    const preset = FLOW_PRESETS[name];
    if (!preset) return;
    const ids = {};
    preset.nodes.forEach(function(n) {
      ids[n.key] = addFlowNode(n.type, n.x, n.y, n.data);
    });
    // Connections after nodes rendered
    setTimeout(function() {
      preset.connections.forEach(function(conn) {
        const fromId = ids[conn[0]], fromOut = parseInt(conn[1]);
        const toId = ids[conn[2]], toIn = parseInt(conn[3]);
        try { flowEditor.addConnection(fromId, toId, 'output_' + fromOut, 'input_' + toIn); } catch(e) {}
      });
    }, 100);
  }

  // ---- Extract config from flow ----
  function flowUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
    });
  }

  function flowToConfig() {
    const exported = flowEditor.export();
    const nodes = Object.values(exported.drawflow.Home.data);

    const modelNodes = nodes.filter(n => n.name === 'model');
    const models = modelNodes.map(function(n) {
      const d = n.data;
      const m = {id: d['model-id']};
      if (d.reasoning) m.reasoning_effort = d.reasoning;
      return m;
    }).filter(m => m.id && m.id.trim());

    const promptNode = nodes.find(n => n.name === 'prompt');
    let prompts = [];
    if (promptNode) {
      try {
        const raw = promptNode.data.prompts;
        const arr = typeof raw === 'string' ? JSON.parse(raw) : (raw || []);
        prompts = arr.filter(Boolean).map(t => ({id: flowUUID(), text: t}));
      } catch(e) { prompts = []; }
    }

    const judgeNode = nodes.find(n => n.name === 'judge');
    const runnerNode = nodes.find(n => n.name === 'runner');

    return {
      name: (runnerNode && runnerNode.data['bench-name']) || 'Flow Benchmark',
      mode: (runnerNode && runnerNode.data.mode) || 'standard',
      models: models,
      prompts: prompts,
      judge: {
        model: (judgeNode && judgeNode.data['judge-model']) || 'google/gemini-3-flash-preview',
        runs: parseInt((judgeNode && judgeNode.data['judge-runs']) || '2')
      },
      generation: {
        temperature: parseFloat((runnerNode && runnerNode.data.temp) || '0.7')
      }
    };
  }

  // ---- Launch ----
  async function launchFlow() {
    if (!flowEditor) return;
    const config = flowToConfig();
    if (!config.models.length) { alert('Add at least one Model node with a model ID.'); return; }
    if (!config.prompts.length) { alert('Add at least one prompt to your Prompt Pack node.'); return; }

    const estEl = document.getElementById('flow-estimate');
    if (estEl) estEl.textContent = 'Creating run...';

    try {
      const r1 = await fetch('/api/runs', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name: config.name, config: config, mode: config.mode})
      });
      const run = await r1.json();
      if (r1.ok) {
        await fetch('/api/runs/' + run.id + '/start', {method:'POST'});
        currentRunId = run.id;
        showPage('run');
        startRunSSE(run.id);
      } else {
        if (estEl) estEl.textContent = 'Error: ' + (run.error || 'unknown');
      }
    } catch(e) {
      if (estEl) estEl.textContent = 'Error: ' + e.message;
    }
  }

  // ---- AI Flow Chat ----
  function flowSummary() {
    if (!flowEditor) return '';
    try {
      const exported = flowEditor.export();
      const nodes = Object.values(exported.drawflow.Home.data);
      const models = nodes.filter(n=>n.name==='model').map(n=>n.data['model-id']).filter(Boolean);
      const promptNode = nodes.find(n=>n.name==='prompt');
      let promptCount = 0;
      if (promptNode) {
        try { const arr = JSON.parse(promptNode.data.prompts||'[]'); promptCount = arr.length; } catch(e) {}
      }
      const judgeNode = nodes.find(n=>n.name==='judge');
      const runnerNode = nodes.find(n=>n.name==='runner');
      return JSON.stringify({
        models: models,
        promptCount: promptCount,
        judgeModel: judgeNode ? judgeNode.data['judge-model'] : null,
        mode: runnerNode ? runnerNode.data.mode : null,
        name: runnerNode ? runnerNode.data['bench-name'] : null
      });
    } catch(e) { return ''; }
  }

  async function sendFlowChat() {
    const inp = document.getElementById('flow-chat-input');
    const msg = inp.value.trim();
    if (!msg) return;
    inp.value = '';

    const msgsEl = document.getElementById('flow-chat-msgs');
    const userDiv = document.createElement('div');
    userDiv.className = 'flow-chat-msg user';
    userDiv.textContent = msg;
    msgsEl.appendChild(userDiv);
    msgsEl.scrollTop = msgsEl.scrollHeight;

    const thinkDiv = document.createElement('div');
    thinkDiv.className = 'flow-chat-msg assistant';
    thinkDiv.textContent = '...';
    msgsEl.appendChild(thinkDiv);
    msgsEl.scrollTop = msgsEl.scrollHeight;

    flowChatHistory.push({role:'user', content: msg});

    try {
      const res = await fetch('/api/flow/ai-assist', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message: msg, currentFlow: flowSummary(), conversation: flowChatHistory.slice(-10)})
      });
      const data = await res.json();
      const reply = data.reply || 'Sorry, something went wrong.';
      flowChatHistory.push({role:'assistant', content: reply});

      // Try to extract and apply JSON patch
      const jsonMatch = reply.match(/```json\s*([\s\S]*?)```/);
      if (jsonMatch) {
        try {
          const patch = JSON.parse(jsonMatch[1].trim());
          applyFlowPatch(patch);
        } catch(e) {}
      }

      // Render reply: plain text with code blocks
      thinkDiv.innerHTML = flowRenderReply(reply);
      msgsEl.scrollTop = msgsEl.scrollHeight;
    } catch(e) {
      thinkDiv.textContent = 'Error: ' + e.message;
    }
  }

  function flowRenderReply(text) {
    // Replace code blocks with <pre>
    const escaped = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return escaped.replace(/```(\w*)\n?([\s\S]*?)```/g, function(_, lang, code) {
      return '<pre>' + code.trim() + '</pre>';
    }).replace(/\n/g, '<br>');
  }

  function applyFlowPatch(patch) {
    if (!flowEditor) return;
    const action = patch.action;
    const data = patch.data || {};

    if (action === 'add_model') {
      addFlowNode('model', 60 + Math.random()*40, 60 + Math.random()*300, {
        'model-id': data['model-id'] || '',
        reasoning: data.reasoning || ''
      });
    } else if (action === 'add_prompt') {
      // Find existing prompt node and add row
      const exported = flowEditor.export();
      const nodes = Object.values(exported.drawflow.Home.data);
      const pNode = nodes.find(n => n.name === 'prompt');
      if (pNode) {
        const rowsEl = document.querySelector('#node-' + pNode.id + ' .prompt-rows');
        if (rowsEl) { flowAddPromptRowText(rowsEl, data.text || ''); flowSyncPrompts(pNode.id); }
      } else {
        addFlowNode('prompt', 60, 400, {prompts: JSON.stringify([data.text || ''])});
      }
    } else if (action === 'set_judge') {
      const exported = flowEditor.export();
      const nodes = Object.values(exported.drawflow.Home.data);
      const jNode = nodes.find(n => n.name === 'judge');
      if (jNode) {
        if (data['judge-model']) {
          const el = document.querySelector('#node-' + jNode.id + ' [df-judge-model]');
          if (el) { el.value = data['judge-model']; jNode.data['judge-model'] = data['judge-model']; }
        }
        if (data['judge-runs']) {
          const el = document.querySelector('#node-' + jNode.id + ' [df-judge-runs]');
          if (el) { el.value = data['judge-runs']; jNode.data['judge-runs'] = String(data['judge-runs']); }
        }
      }
    } else if (action === 'set_mode') {
      const exported = flowEditor.export();
      const nodes = Object.values(exported.drawflow.Home.data);
      const rNode = nodes.find(n => n.name === 'runner');
      if (rNode && data.mode) {
        const el = document.querySelector('#node-' + rNode.id + ' [df-mode]');
        if (el) { el.value = data.mode; rNode.data.mode = data.mode; }
      }
    } else if (action === 'set_name') {
      const exported = flowEditor.export();
      const nodes = Object.values(exported.drawflow.Home.data);
      const rNode = nodes.find(n => n.name === 'runner');
      if (rNode && data.name) {
        const el = document.querySelector('#node-' + rNode.id + ' [df-bench-name]');
        if (el) { el.value = data.name; rNode.data['bench-name'] = data.name; }
      }
    } else if (action === 'clear') {
      clearFlow();
    } else if (action === 'load_preset') {
      loadFlowPreset(data.name);
    }
  }

</script>
</body>
</html>